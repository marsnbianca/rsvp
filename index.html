<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSVP</title>

  <style>
    :root{
      --overlay: rgba(0,0,0,.40);

      --card:#f6f7fb;
      --text:#141418;
      --muted:#5a5a66;
      --line:#dcdde6;
      --err:#c62828;

      /* nav buttons */
      --btn:#141418;
      --btnText:#ffffff;
      --btnHover:#2a2a2f;

      /* choice buttons (Yes/No) */
      --choiceBg:#ffffff;
      --choiceText:#141418;
      --choiceLine:#cfd0da;
      --choiceHover:#f0f1f7;
      --choiceSelectedBg:#141418;
      --choiceSelectedText:#ffffff;

      /* name buttons */
      --nameBg:#ffffff;
      --nameHover:#f0f1f7;

      --shadow: 0 14px 40px rgba(0,0,0,.18);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: transparent;
    }

    /* Overlay modal */
    .overlay{
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 16px;
      background: var(--overlay);
    }

    .modal{
      width: min(560px, 100%);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.35);
      overflow: hidden;
    }

    .modal-inner{ padding: 18px; }

    .title{
      font-size: 20px;
      font-weight: 800;
      margin: 0 0 6px 0;
      text-align: center;
      letter-spacing: .2px;
    }

    .sub{
      margin: 0 0 14px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      text-align: center;
    }

    .divider{
      height: 1px;
      background: var(--line);
      margin: 14px 0;
    }

    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
      margin: 10px 0;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
    }
    input[type="text"], input[type="tel"]{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 14px;
      outline: none;
    }
    input[type="text"]:focus, input[type="tel"]:focus{
      border-color: #b9bbca;
    }

    .error{
      color: var(--err);
      font-size: 12px;
      margin-top: 8px;
      text-align: center;
    }

    button{
      border: none;
      cursor: pointer;
      font: inherit;
      -webkit-tap-highlight-color: transparent;
    }

    /* Name match buttons */
    .btn-name{
      width: 100%;
      text-align: left;
      padding: 12px 12px;
      border-radius: 12px;
      background: var(--nameBg);
      border: 1px solid var(--line);
      margin: 8px 0 0 0;
      transition: background .15s ease, transform .02s ease;
    }
    .btn-name:hover{ background: var(--nameHover); }
    .btn-name:active{ transform: translateY(1px); }

    /* Choice buttons (Yes/No) */
    .choice-row{
      display:flex;
      gap: 10px;
      margin-top: 8px;
    }
    .btn-choice{
      flex: 1;
      padding: 12px 12px;
      border-radius: 12px;
      background: var(--choiceBg);
      color: var(--choiceText);
      border: 1px solid var(--choiceLine);
      transition: background .15s ease, color .15s ease, transform .02s ease;
      text-align: center;
      font-weight: 700;
    }
    .btn-choice:hover{ background: var(--choiceHover); }
    .btn-choice.is-selected{
      background: var(--choiceSelectedBg);
      color: var(--choiceSelectedText);
      border-color: var(--choiceSelectedBg);
    }
    .btn-choice:active{ transform: translateY(1px); }

    /* Nav buttons */
    .nav{
      display:flex;
      gap: 10px;
      padding: 14px 18px;
      border-top: 1px solid var(--line);
      background: rgba(255,255,255,.35);
      align-items: center;
    }
    .btn-nav{
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--btn);
      color: var(--btnText);
      font-weight: 800;
      transition: background .15s ease, transform .02s ease, opacity .15s ease;
      min-width: 110px;
    }
    .btn-nav:hover{ background: var(--btnHover); }
    .btn-nav:active{ transform: translateY(1px); }
    .btn-nav.ghost{
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line);
      font-weight: 800;
    }
    .btn-nav.ghost:hover{ background: #eef0f8; }
    .btn-nav:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    /* Attendees */
    .attendee-block{
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .attendee-row{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    .attendee-head{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .attendee-title{
      font-weight: 900;
      font-size: 13px;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
    }

    .center-actions{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .spinner{
      display:inline-block;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.18);
      border-top-color: rgba(0,0,0,.55);
      animation: spin 700ms linear infinite;
      vertical-align: -3px;
      margin-right: 8px;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
  </style>
</head>

<body>
  <div class="overlay" id="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-inner">
        <h1 class="title" id="title">Find your invite</h1>
        <p class="sub" id="sub">Enter your name to look up your invitation.</p>

        <div id="content"></div>
        <div class="error" id="error" style="display:none;"></div>
      </div>

      <div class="nav" id="nav" style="display:none;">
        <button class="btn-nav ghost" id="backBtn" type="button">Back</button>
        <div style="flex:1;"></div>
        <button class="btn-nav" id="submitBtn" type="button">Submit</button>
        <button class="btn-nav ghost" id="closeBtn" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      webAppUrl: "https://script.google.com/macros/s/AKfycbxNMaS4bQoEICGBUa6uH5qL4BOGjhK_f1CajHkSWJkgDe_tTrbAM0KyWHKQd0YKQ4BMxA/exec"
    };

    const state = {
      step: "find", // find | matches | questions | done
      matches: [],
      invite: null,
      responses: { attending:"", transportation:"", phone:"", party: [] },
      busy: false
    };

    const $ = (id) => document.getElementById(id);

    const titleEl = $("title");
    const subEl = $("sub");
    const contentEl = $("content");
    const errorEl = $("error");
    const navEl = $("nav");

    const backBtn = $("backBtn");
    const submitBtn = $("submitBtn");
    const closeBtn = $("closeBtn");

    init();

    function init(){
      backBtn.addEventListener("click", onBack);
      submitBtn.addEventListener("click", onSubmit);
      closeBtn.addEventListener("click", () => closeModal());
      renderFind();
    }

    function closeModal(){
      $("overlay").style.display = "none";
    }

    function setError(msg){
      if (!msg){
        errorEl.style.display = "none";
        errorEl.textContent = "";
        return;
      }
      errorEl.style.display = "block";
      errorEl.textContent = msg;
    }

    function setBusy(isBusy, label){
      state.busy = isBusy;
      backBtn.disabled = isBusy;
      submitBtn.disabled = isBusy;
      closeBtn.disabled = isBusy;

      if (isBusy && label){
        submitBtn.dataset.prev = submitBtn.textContent;
        submitBtn.innerHTML = `<span class="spinner"></span>${label}`;
      } else {
        if (submitBtn.dataset.prev) submitBtn.textContent = submitBtn.dataset.prev;
      }
    }

    // FINAL FIX: preflight-safe POST (no application/json, no custom headers)
    async function post(action, payload){
      const res = await fetch(CONFIG.webAppUrl, {
        method: "POST",
        mode: "cors",
        cache: "no-store",
        redirect: "follow",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, ...payload })
      });

      // If Apps Script returns HTML on error, this avoids a JSON crash
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error("Server did not return JSON. Check web app deployment access."); }
    }

    /* STEP 1: FIND */
    function renderFind(){
      state.step = "find";
      state.matches = [];
      state.invite = null;
      state.responses = { attending:"", transportation:"", phone:"", party: [] };
      setError("");

      titleEl.textContent = "Find your invite";
      subEl.textContent = "Enter your name to look up your invitation.";
      navEl.style.display = "none";

      contentEl.innerHTML = `
        <div class="field">
          <div class="label">Full name</div>
          <input id="nameInput" type="text" autocomplete="name" placeholder="Type your name" />
        </div>
        <div class="center-actions">
          <button class="btn-nav" type="button" id="findBtn" style="width:100%;">Search</button>
        </div>
      `;

      const nameInput = $("nameInput");
      const findBtn = $("findBtn");

      findBtn.addEventListener("click", async () => {
        const q = (nameInput.value || "").trim();
        if (!q) return setError("Please enter your name.");
        await doFind(q);
      });

      nameInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter"){
          const q = (nameInput.value || "").trim();
          if (!q) return setError("Please enter your name.");
          await doFind(q);
        }
      });
    }

    async function doFind(query){
      setError("");
      setBusy(true, "Searching");
      try{
        const data = await post("find", { query });
        if (!data.ok) throw new Error(data.error || "Search failed.");
        state.matches = data.matches || [];

        if (!state.matches.length){
          return setError("No match found. Please check the spelling and try again.");
        }

        if (state.matches.length === 1){
          await doGet(state.matches[0].invite_id);
          return;
        }

        renderMatches();
      } catch(err){
        setError(String(err.message || err));
      } finally {
        setBusy(false, "");
      }
    }

    /* STEP 2: MULTI MATCH */
    function renderMatches(){
      state.step = "matches";
      setError("");

      titleEl.textContent = "Which invite is yours?";
      subEl.textContent = "Select your name from the list.";
      navEl.style.display = "none";

      contentEl.innerHTML = `
        <div>
          ${(state.matches || []).map(m => `
            <button type="button" class="btn-name" data-id="${escapeHtml(m.invite_id)}">
              ${escapeHtml(m.display_name)}
              ${m.party_size ? `<div class="small">${m.party_size} in party</div>` : ``}
            </button>
          `).join("")}
        </div>
        <div class="divider"></div>
        <button class="btn-nav ghost" type="button" id="backToFindBtn" style="width:100%;">Back</button>
      `;

      contentEl.querySelectorAll(".btn-name").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          await doGet(id);
        });
      });

      $("backToFindBtn").addEventListener("click", renderFind);
    }

    async function doGet(invite_id){
      setError("");
      setBusy(true, "Loading");
      try{
        const data = await post("get", { invite_id });
        if (!data.ok) throw new Error(data.error || "Could not load invite.");
        state.invite = data.invite;

        const party = (state.invite.party || []).map((p, i) => ({
          row_index: p.row_index,
          attendee_id: p.attendee_id || String(i + 1),
          full_name: p.full_name || "",
          status: p.status || "",
          transportation: p.transportation || "",
          phone: p.phone || ""
        }));

        state.responses.party = party;

        renderQuestions();
      } catch(err){
        setError(String(err.message || err));
      } finally {
        setBusy(false, "");
      }
    }

    /* STEP 3: QUESTIONS */
    function renderQuestions(){
      state.step = "questions";
      setError("");

      titleEl.textContent = "RSVP";
      subEl.textContent = "Please answer a few quick questions.";
      navEl.style.display = "flex";
      backBtn.style.display = "inline-flex";
      submitBtn.style.display = "inline-flex";

      contentEl.innerHTML = `
        <div class="field">
          <div class="label">Phone number (optional)</div>
          <input id="phoneInput" type="tel" inputmode="tel" placeholder="e.g. 778-123-4567" />
        </div>

        <div class="divider"></div>

        <div class="field">
          <div class="label">Are you coming?</div>
          <div class="choice-row">
            <button type="button" class="btn-choice" data-q="attending" data-v="Yes">Yes</button>
            <button type="button" class="btn-choice" data-q="attending" data-v="No">No</button>
          </div>
        </div>

        <div class="field">
          <div class="label">Transportation</div>
          <div class="choice-row">
            <button type="button" class="btn-choice" data-q="transportation" data-v="Yes">Yes</button>
            <button type="button" class="btn-choice" data-q="transportation" data-v="No">No</button>
          </div>
          <div class="small" style="margin-top:6px; text-align:center;">
            Select “Yes” if you need transportation arranged.
          </div>
        </div>

        <div class="divider"></div>

        <div class="field">
          <div class="label">Attendees</div>
          <div class="small" style="text-align:center;">Confirm the full names below.</div>

          <div class="attendee-block">
            ${(state.responses.party || []).map((p, idx) => `
              <div class="attendee-row" data-idx="${idx}">
                <div class="attendee-head">
                  <div class="attendee-title">Attendee ${idx + 1}</div>
                  <div class="small">ID: ${escapeHtml(p.attendee_id || String(idx+1))}</div>
                </div>
                <div class="field" style="margin:0;">
                  <div class="label">Full name</div>
                  <input type="text" class="attendeeNameInput" value="${escapeAttr(p.full_name || "")}" placeholder="Full name" />
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      `;

      const phoneInput = $("phoneInput");
      const firstPhone = (state.responses.party[0] && state.responses.party[0].phone) ? state.responses.party[0].phone : "";
      phoneInput.value = formatPhoneLoose(firstPhone || state.responses.phone || "");

      wireChoiceGroup("attending");
      wireChoiceGroup("transportation");

      if (state.responses.attending) setChoiceSelected("attending", state.responses.attending);
      if (state.responses.transportation) setChoiceSelected("transportation", state.responses.transportation);
    }

    function wireChoiceGroup(questionKey){
      contentEl.querySelectorAll(`.btn-choice[data-q="${questionKey}"]`).forEach(btn => {
        btn.addEventListener("click", () => {
          const v = btn.getAttribute("data-v");
          state.responses[questionKey] = v;
          setChoiceSelected(questionKey, v);
        });
      });
    }

    function setChoiceSelected(questionKey, value){
      contentEl.querySelectorAll(`.btn-choice[data-q="${questionKey}"]`).forEach(b => {
        b.classList.toggle("is-selected", b.getAttribute("data-v") === value);
      });
    }

    function onBack(){
      renderFind();
    }

    async function onSubmit(){
      setError("");

      const phoneInput = $("phoneInput");
      state.responses.phone = formatPhoneLoose(phoneInput.value || "");

      if (!state.responses.attending){
        return setError("Please answer “Are you coming?”");
      }

      const attendeeRows = Array.from(contentEl.querySelectorAll(".attendee-row"));
      const party = attendeeRows.map((row) => {
        const idx = Number(row.getAttribute("data-idx"));
        const input = row.querySelector(".attendeeNameInput");
        const existing = state.responses.party[idx] || {};

        return {
          row_index: existing.row_index,
          attendee_id: existing.attendee_id,
          full_name: (input && input.value ? input.value.trim() : ""), // attendee 1 always included
          phone: state.responses.phone
        };
      });

      if (!party[0] || !party[0].full_name){
        return setError("Please confirm the full name for Attendee 1.");
      }

      setBusy(true, "Submitting");

      try{
        const payload = {
          invite_id: state.invite.invite_id,
          invite_name: state.invite.invite_name,
          responses: {
            attending: state.responses.attending,           // server writes to status
            transportation: state.responses.transportation,
            phone: state.responses.phone,
            party
          }
        };

        const data = await post("submit", payload);
        if (!data.ok) throw new Error(data.error || "Submit failed.");

        renderDone();
      } catch(err){
        setError(String(err.message || err));
      } finally {
        setBusy(false, "");
      }
    }

    function renderDone(){
      state.step = "done";
      setError("");

      titleEl.textContent = "Thank you!";
      subEl.textContent = "Your RSVP has been saved.";
      navEl.style.display = "flex";
      backBtn.style.display = "none";
      submitBtn.style.display = "none";

      contentEl.innerHTML = `
        <div class="small" style="text-align:center;">
          If you need to make changes, refresh and submit again.
        </div>
      `;
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(s).replace(/"/g,"&quot;");
    }

    function formatPhoneLoose(raw){
      const s = String(raw || "").trim();
      if (!s) return "";
      const hasPlus = s.startsWith("+");
      const digits = s.replace(/[^\d]/g, "");
      if (hasPlus) return "+" + digits;
      if (digits.length === 10){
        return digits.slice(0,3) + "-" + digits.slice(3,6) + "-" + digits.slice(6);
      }
      if (digits.length === 11 && digits.startsWith("0")){
        return digits;
      }
      return s;
    }
  </script>
</body>
</html>
