<!-- /rsvp/index.html  (V3 + responsive + dark overlay + title-cased attendee names + click-outside-close) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RSVP</title>

  <style>
    :root{
      /* Dark overlay (this is the backdrop you see in GitHub Pages) */
      --bg: rgba(15, 15, 20, 0.62);

      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 24px 80px rgba(0,0,0,.18);
      --radius: 18px;

      --btn: #111827;
      --btnText: #ffffff;
      --btnAlt: #f3f4f6;
      --btnAltText: #111827;

      --danger: #b91c1c;
      --ok: #166534;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: transparent;
      color: var(--text);
      overflow: hidden; /* prevent background scroll when modal is open */
    }

    /* Overlay */
    #overlay{
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      box-sizing: border-box;
      overflow: auto; /* allow scroll on very small screens */
      -webkit-overflow-scrolling: touch;
    }

    /* Modal */
    #modal{
      width: min(560px, calc(100vw - 28px));
      max-height: calc(100svh - 28px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .title{
      margin:0;
      font-size: clamp(16px, 2.2vw, 18px);
      line-height: 1.2;
      letter-spacing: .2px;
    }

    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: clamp(12px, 1.8vw, 13px);
      line-height: 1.35;
    }

    .headerBtns{
      display:flex;
      gap: 8px;
      flex-shrink: 0;
    }

    main{
      padding: 14px 16px 16px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .row{ display:flex; gap: 10px; align-items: center; }
    .col{ display:flex; flex-direction: column; gap: 10px; }

    label{
      font-size: clamp(12px, 1.8vw, 13px);
      color: var(--muted);
      margin-bottom: 6px;
      display:block;
    }

    input, textarea, select{
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
      color: var(--text);
    }

    textarea{ min-height: 92px; resize: vertical; }

    .help{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    .err{
      color: var(--danger);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .ok{
      color: var(--ok);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }

    .btn{
      appearance: none;
      border: 0;
      border-radius: 12px;
      padding: 11px 12px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .btn.primary{ background: var(--btn); color: var(--btnText); }
    .btn.secondary{
      background: var(--btnAlt);
      color: var(--btnAltText);
      border: 1px solid var(--border);
    }

    .btn:disabled{ opacity: .55; cursor: not-allowed; }

    .btn.pill{
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
    }
    .btn.pill.active{
      background: var(--btn);
      color: var(--btnText);
      border-color: var(--btn);
    }

    .btn.pickBtn{
      width: 100%;
      text-align: left;
      background: #fff;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
    }
    .btn.pickBtn:hover{ background: #f9fafb; }

    .footer{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .footer .left, .footer .right{ display:flex; gap: 10px; flex-wrap: wrap; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      font-size: 12px;
      color: var(--muted);
      width: fit-content;
    }

    .divider{ height: 1px; background: var(--border); margin: 14px 0; }
    .hidden{ display:none !important; }

    .summaryBox{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }

    .summaryLine{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
      padding: 6px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .summaryLine:last-child{ border-bottom: 0; }
    .summaryKey{ color: var(--muted); }
    .summaryVal{ color: var(--text); text-align: right; }

    .contactLine{
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* Mobile tweaks */
    @media (max-width: 420px){
      header{ padding: 14px 14px 10px; }
      main{ padding: 12px 14px 14px; }
      .headerBtns{ flex-direction: column; align-items: stretch; }
      .headerBtns .btn{ width: 100%; }
    }
  </style>
</head>

<body>
  <div id="overlay" role="dialog" aria-modal="true" aria-label="RSVP">
    <div id="modal">
      <header>
        <div>
          <h1 class="title" id="headerTitle">RSVP</h1>
          <p class="subtitle" id="headerSubtitle">Find your invite to get started.</p>
        </div>
        <div class="headerBtns">
          <button class="btn secondary" id="startOverBtn" type="button">Start over</button>
          <button class="btn secondary" id="closeBtn" type="button">Close</button>
        </div>
      </header>

      <main>
        <!-- FIND -->
        <section id="stepFind" class="col">
          <div>
            <label for="nameInput">Full name</label>
            <input id="nameInput" type="text" inputmode="text" autocomplete="name" placeholder="Type your name" />
            <div class="help">Tip: try first and last name.</div>
            <div id="findErr" class="err hidden"></div>
          </div>

          <div class="footer">
            <div class="left"></div>
            <div class="right">
              <button class="btn primary" id="findBtn" type="button">Find my invite</button>
            </div>
          </div>
        </section>

        <!-- PICK -->
        <section id="stepPick" class="col hidden">
          <div class="chip" id="pickChip">Multiple matches found</div>
          <div id="pickList" class="col"></div>
          <div id="pickErr" class="err hidden"></div>

          <div class="footer">
            <div class="left">
              <button class="btn secondary" id="pickBackBtn" type="button">Back</button>
            </div>
            <div class="right"></div>
          </div>
        </section>

        <!-- COMING -->
        <section id="stepComing" class="col hidden">
          <div class="summaryBox">
            <div class="summaryLine">
              <div class="summaryKey">Invite</div>
              <div class="summaryVal" id="sumInviteName">-</div>
            </div>
            <div class="summaryLine">
              <div class="summaryKey">Seats</div>
              <div class="summaryVal" id="sumSeats">-</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="col">
            <div>
              <div class="row" style="justify-content: space-between;">
                <div>
                  <label style="margin:0;">Will you be attending?</label>
                </div>
                <div class="row">
                  <button class="btn pill" id="btnYes" type="button">Yes</button>
                  <button class="btn pill" id="btnNo" type="button">No</button>
                </div>
              </div>
              <div id="comingErr" class="err hidden"></div>
            </div>

            <div id="attendingBox" class="col hidden">
              <div>
                <label for="countSelect">How many in your party will attend?</label>
                <select id="countSelect"></select>
                <div class="help">Max: <span id="maxSeatsLabel">4</span></div>
              </div>

              <div id="attendeeInputs" class="col"></div>
            </div>
          </div>

          <div class="footer">
            <div class="left">
              <button class="btn secondary" id="comingBackBtn" type="button">Back</button>
            </div>
            <div class="right">
              <button class="btn primary" id="comingNextBtn" type="button">Next</button>
            </div>
          </div>
        </section>

        <!-- TRANSPO -->
        <section id="stepTranspo" class="col hidden">
          <div>
            <label>Transportation</label>
            <div class="row" style="flex-wrap: wrap;">
              <button class="btn pill" data-transpo="Driving" type="button">Driving</button>
              <button class="btn pill" data-transpo="Commute" type="button">Commute</button>
              <button class="btn pill" data-transpo="Need a ride" type="button">Need a ride</button>
              <button class="btn pill" data-transpo="Not sure yet" type="button">Not sure yet</button>
            </div>
            <div id="transpoErr" class="err hidden"></div>
          </div>

          <div class="footer">
            <div class="left">
              <button class="btn secondary" id="transpoBackBtn" type="button">Back</button>
            </div>
            <div class="right">
              <button class="btn primary" id="transpoNextBtn" type="button">Next</button>
            </div>
          </div>
        </section>

        <!-- PHONE -->
        <section id="stepPhone" class="col hidden">
          <div>
            <label for="phoneInput">Phone number (Philippines)</label>
            <input id="phoneInput" type="tel" inputmode="numeric" autocomplete="tel" placeholder="09XX XXX XXXX" maxlength="13" />
            <div class="help">Format: 09XX XXX XXXX</div>
            <div id="phoneErr" class="err hidden"></div>
          </div>

          <div class="footer">
            <div class="left">
              <button class="btn secondary" id="phoneBackBtn" type="button">Back</button>
            </div>
            <div class="right">
              <button class="btn primary" id="phoneNextBtn" type="button">Next</button>
            </div>
          </div>
        </section>

        <!-- NOTES -->
        <section id="stepNotes" class="col hidden">
          <div>
            <label for="notesInput">Notes (optional)</label>
            <textarea id="notesInput" placeholder="Dietary restrictions, questions, anything to share"></textarea>
          </div>

          <div class="footer">
            <div class="left">
              <button class="btn secondary" id="notesBackBtn" type="button">Back</button>
            </div>
            <div class="right">
              <button class="btn primary" id="submitBtn" type="button">Submit RSVP</button>
            </div>
          </div>

          <div id="submitErr" class="err hidden"></div>
          <div id="submitOk" class="ok hidden"></div>
        </section>

        <!-- THANKS -->
        <section id="stepThanks" class="col hidden">
          <div class="summaryBox">
            <div style="font-size:16px; font-weight:600;">Thanks, you’re all set.</div>
            <div class="help" id="thanksLine" style="margin-top:8px;">RSVP received.</div>
            <div class="contactLine" id="contactLine"></div>
          </div>

          <div class="footer">
            <div class="left"></div>
            <div class="right">
              <button class="btn secondary" id="thanksCloseBtn" type="button">Close</button>
            </div>
          </div>
        </section>

        <!-- DECLINED -->
        <section id="stepDeclined" class="col hidden">
          <div class="summaryBox">
            <div style="font-size:16px; font-weight:600;">Got it. Thank you for letting us know.</div>
            <div class="help" style="margin-top:8px;">Your response has been recorded.</div>
            <div class="contactLine" id="contactLine2"></div>
          </div>

          <div class="footer">
            <div class="left"></div>
            <div class="right">
              <button class="btn secondary" id="declineCloseBtn" type="button">Close</button>
            </div>
          </div>
        </section>

        <!-- LOCKED -->
        <section id="stepLocked" class="col hidden">
          <div class="summaryBox">
            <div style="font-size:16px; font-weight:600;">RSVP already received</div>
            <div class="help" style="margin-top:8px;">
              If you need to update your RSVP, please contact Bianca &amp; Mars (or the coordinator).
            </div>
            <div class="contactLine" id="contactLine3"></div>
          </div>

          <div class="footer">
            <div class="left"></div>
            <div class="right">
              <button class="btn secondary" id="lockedCloseBtn" type="button">Close</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    /* =========================
       CONFIG (v3 snapshot)
    ========================== */
    var CONFIG = {
      webAppUrl: "https://script.google.com/macros/s/AKfycbxNMaS4bQoEICGBUa6uH5qL4BOGjhK_f1CajHkSWJkgDe_tTrbAM0KyWHKQd0YKQ4BMxA/exec",
      maxSeatsCap: 4,
      contactLineText:
        "If you already RSVP’d and need to update something, please contact Bianca & Mars (or the coordinator) at +63 XXX XXX XXXX (WhatsApp/Viber)."
    };

    /* =========================
       Helpers
    ========================== */
    function $(id){ return document.getElementById(id); }
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setText(el, txt){ el.textContent = txt; }
    function showErr(el, msg){ setText(el, msg); show(el); }
    function clearErr(el){ setText(el, ""); hide(el); }

    function normalizeSpaces_(s){
      return (s || "").replace(/\s+/g, " ").trim();
    }

    // Title Case per word, keeps hyphens and apostrophes
    function titleCaseName_(s){
      s = normalizeSpaces_(s).toLowerCase();
      var out = "";
      var capNext = true;

      for (var i = 0; i < s.length; i++){
        var ch = s[i];
        if (capNext && /[a-z]/.test(ch)){
          out += ch.toUpperCase();
          capNext = false;
        } else {
          out += ch;
        }
        if (ch === " " || ch === "-" || ch === "'") capNext = true;
      }
      return out;
    }

    function hideAllSteps(){
      hide($("stepFind"));
      hide($("stepPick"));
      hide($("stepComing"));
      hide($("stepTranspo"));
      hide($("stepPhone"));
      hide($("stepNotes"));
      hide($("stepThanks"));
      hide($("stepDeclined"));
      hide($("stepLocked"));
    }

    function go(stepId, title, subtitle){
      hideAllSteps();
      show($(stepId));
      if (title) setText($("headerTitle"), title);
      if (subtitle) setText($("headerSubtitle"), subtitle);
      $("modal").scrollTop = 0;
      $("overlay").scrollTop = 0;
    }

    function postJson(action, payload){
      return fetch(CONFIG.webAppUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(Object.assign({ action: action }, payload || {}))
      }).then(function(r){ return r.json(); });
    }

    /* =========================
       Close behavior for Readymag iframe mode
    ========================== */
    function closeRSVP(){
      // Embedded in Readymag overlay iframe
      if (window.parent && window.parent !== window) {
        window.parent.postMessage("RSVP:CLOSE", "*");
        return;
      }

      // If opened as a popup via window.open
      if (window.opener && !window.opener.closed) {
        window.close();
        return;
      }

      // Fallback if opened directly
      window.location.href = "/";
    }

    /* =========================
       Phone v3 rules
       - UI stores digits only
       - Display formats as 09XX XXX XXXX
       - Validate at Phone step and again on Submit
       - Store exactly the visible formatted phone in the sheet
    ========================== */
    var phoneDigits = "";

    function digitsOnly(s){
      return (s || "").replace(/\D+/g, "");
    }

    function formatPHVisible(d){
      var x = (d || "");

      // If user pasted +63..., try to convert to 0...
      if (x.indexOf("63") === 0 && x.length >= 12) {
        x = "0" + x.slice(2);
      }

      x = x.slice(0, 11);

      // Format as 09XX XXX XXXX
      var a = x.slice(0, 4);
      var b = x.slice(4, 7);
      var c = x.slice(7, 11);

      var out = a;
      if (b.length) out += " " + b;
      if (c.length) out += " " + c;
      return out.trim();
    }

    function isValidPHVisible(visible){
      return /^09\d{2}\s\d{3}\s\d{4}$/.test((visible || "").trim());
    }

    function setPhoneFromInput(){
      phoneDigits = digitsOnly($("phoneInput").value);
      var visible = formatPHVisible(phoneDigits);
      $("phoneInput").value = visible;
      return visible;
    }

    function validatePhone(showMessage){
      var visible = setPhoneFromInput();

      if (!visible || visible.length === 0) {
        if (showMessage) showErr($("phoneErr"), "Phone number is required.");
        return { ok: false, kind: "required", visible: visible };
      }
      if (!isValidPHVisible(visible)) {
        if (showMessage) showErr($("phoneErr"), "Phone number is invalid. Please use 09XX XXX XXXX.");
        return { ok: false, kind: "invalid", visible: visible };
      }

      clearErr($("phoneErr"));
      return { ok: true, kind: "ok", visible: visible };
    }

    /* =========================
       State
    ========================== */
    var state = {
      queryName: "",
      matches: [],
      selected: null,
      inviteId: null,
      status: null,
      attendingCount: 0,
      attendees: [],
      transportation: "",
      phoneVisible: "",
      notes: ""
    };

    function resetState(){
      state = {
        queryName: "",
        matches: [],
        selected: null,
        inviteId: null,
        status: null,
        attendingCount: 0,
        attendees: [],
        transportation: "",
        phoneVisible: "",
        notes: ""
      };
      phoneDigits = "";
      $("nameInput").value = "";
      $("notesInput").value = "";
      $("phoneInput").value = "";
      clearErr($("findErr"));
      clearErr($("pickErr"));
      clearErr($("comingErr"));
      clearErr($("transpoErr"));
      clearErr($("phoneErr"));
      clearErr($("submitErr"));
      hide($("submitOk"));
      setText($("submitOk"), "");
      setText($("contactLine"), CONFIG.contactLineText);
      setText($("contactLine2"), CONFIG.contactLineText);
      setText($("contactLine3"), CONFIG.contactLineText);
      buildCountSelect(CONFIG.maxSeatsCap);
      buildAttendeeInputs(1);
      setYesNo(null);
      hide($("attendingBox"));
      go("stepFind", "RSVP", "Find your invite to get started.");
    }

    /* =========================
       UI builders
    ========================== */
    function buildCountSelect(max){
      var sel = $("countSelect");
      sel.innerHTML = "";
      var cap = Math.max(1, Math.min(CONFIG.maxSeatsCap, max || CONFIG.maxSeatsCap));
      setText($("maxSeatsLabel"), String(cap));
      for (var i = 1; i <= cap; i++){
        var opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        sel.appendChild(opt);
      }
      sel.value = "1";
    }

    function buildAttendeeInputs(n){
      var box = $("attendeeInputs");
      box.innerHTML = "";
      for (var i = 0; i < n; i++){
        var wrap = document.createElement("div");

        var lab = document.createElement("label");
        lab.textContent = (i === 0) ? "Attendee full name" : ("Attendee " + (i+1) + " full name");

        var inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "Type full name";
        inp.dataset.idx = String(i);

        inp.addEventListener("input", function(e){
          var idx = parseInt(e.target.dataset.idx, 10);
          state.attendees[idx] = normalizeSpaces_(e.target.value);
        });

        inp.addEventListener("blur", function(e){
          var idx = parseInt(e.target.dataset.idx, 10);
          var fixed = titleCaseName_(e.target.value);
          e.target.value = fixed;
          state.attendees[idx] = fixed;
        });

        wrap.appendChild(lab);
        wrap.appendChild(inp);
        box.appendChild(wrap);
      }
      state.attendees = new Array(n).fill("");
    }

    function setYesNo(val){
      var yes = $("btnYes");
      var no = $("btnNo");
      yes.classList.remove("active");
      no.classList.remove("active");
      if (val === "Yes") yes.classList.add("active");
      if (val === "No") no.classList.add("active");
    }

    function setTranspo(val){
      state.transportation = val || "";
      var btns = $("stepTranspo").querySelectorAll(".btn.pill[data-transpo]");
      btns.forEach(function(b){
        b.classList.toggle("active", b.getAttribute("data-transpo") === state.transportation);
      });
    }

    function renderPickList(matches){
      var list = $("pickList");
      list.innerHTML = "";
      matches.forEach(function(m){
        var btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn pickBtn";
        btn.textContent = m.display_name || m.name || "Select";
        btn.addEventListener("click", function(){ selectMatch(m); });
        list.appendChild(btn);
      });
    }

    function updateSummary(){
      setText($("sumInviteName"), (state.selected && (state.selected.display_name || state.selected.name)) || "-");
      var seats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
      setText($("sumSeats"), String(seats));
    }

    /* =========================
       Flow logic
    ========================== */
    function startFind(){
      clearErr($("findErr"));
      var q = normalizeSpaces_($("nameInput").value);
      state.queryName = q;

      if (!q) {
        showErr($("findErr"), "Please enter your name.");
        return;
      }

      $("findBtn").disabled = true;

      postJson("find", { name: q })
        .then(function(res){
          $("findBtn").disabled = false;

          if (!res || res.ok === false) {
            showErr($("findErr"), (res && res.error) ? res.error : "Something went wrong. Please try again.");
            return;
          }

          var matches = res.matches || [];
          state.matches = matches;

          if (matches.length === 0) {
            showErr($("findErr"), "No match found. Please check spelling or try a different name.");
            return;
          }

          if (matches.length === 1) {
            selectMatch(matches[0]);
            return;
          }

          renderPickList(matches);
          clearErr($("pickErr"));
          go("stepPick", "Select your invite", "Choose the name that matches your invite.");
        })
        .catch(function(){
          $("findBtn").disabled = false;
          showErr($("findErr"), "Network error. Please try again.");
        });
    }

    function selectMatch(match){
      var inviteId = match.invite_id || match.id || match.key;
      if (!inviteId) {
        showErr($("pickErr"), "This invite is missing an ID. Please try again.");
        return;
      }

      state.inviteId = inviteId;

      postJson("get", { invite_id: inviteId })
        .then(function(res){
          if (!res || res.ok === false) {
            showErr($("pickErr"), (res && res.error) ? res.error : "Unable to load invite. Please try again.");
            return;
          }

          if (res.locked) {
            go("stepLocked", "RSVP", "RSVP already received.");
            return;
          }

          state.selected = res.invite || match;

          var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
          buildCountSelect(maxSeats);
          buildAttendeeInputs(1);
          updateSummary();

          clearErr($("comingErr"));
          setYesNo(null);
          hide($("attendingBox"));

          go("stepComing", "RSVP", "Will you be attending?");
        })
        .catch(function(){
          showErr($("pickErr"), "Network error. Please try again.");
        });
    }

    function comingNext(){
      clearErr($("comingErr"));

      if (!state.status) {
        showErr($("comingErr"), "Please select Yes or No.");
        return;
      }

      if (state.status === "Declined") {
        submitRSVP(true);
        return;
      }

      state.attendingCount = parseInt($("countSelect").value, 10) || 1;

      var missing = [];
      for (var i = 0; i < state.attendingCount; i++){
        var v = normalizeSpaces_(state.attendees[i]);
        state.attendees[i] = titleCaseName_(v);
        if (!state.attendees[i]) missing.push(i+1);
      }
      if (missing.length) {
        showErr($("comingErr"), "Please enter attendee name" + (missing.length > 1 ? "s" : "") + " for your party.");
        return;
      }

      clearErr($("transpoErr"));
      setTranspo(state.transportation || "");
      go("stepTranspo", "RSVP", "Transportation details");
    }

    function transpoNext(){
      clearErr($("transpoErr"));
      if (!state.transportation) {
        showErr($("transpoErr"), "Please select a transportation option.");
        return;
      }
      clearErr($("phoneErr"));
      go("stepPhone", "RSVP", "Contact number");
    }

    function phoneNext(){
      var v = validatePhone(true);
      if (!v.ok) return;

      state.phoneVisible = v.visible;
      go("stepNotes", "RSVP", "Any notes?");
    }

    function submitRSVP(){
      clearErr($("submitErr"));
      hide($("submitOk"));
      setText($("submitOk"), "");

      if (state.status === "Attending") {
        // Force Title Case on submit too
        state.attendees = (state.attendees || []).map(function(nm){ return titleCaseName_(nm); });

        var v = validatePhone(true);
        if (!v.ok) {
          showErr($("submitErr"),
            v.kind === "required"
              ? "Phone number is required. Please go back and enter 09XX XXX XXXX."
              : "Phone number is invalid. Please go back and use 09XX XXX XXXX."
          );
          return;
        }
        state.phoneVisible = v.visible;
      } else {
        state.phoneVisible = "";
      }

      state.notes = normalizeSpaces_($("notesInput").value);

      var payload = {
        invite_id: state.inviteId,
        status: state.status,
        attending_count: state.status === "Attending" ? state.attendingCount : 0,
        phone: state.phoneVisible || "",
        transportation: state.status === "Attending" ? (state.transportation || "") : "",
        notes: state.notes || "",
        attendees: state.status === "Attending" ? state.attendees.slice(0, state.attendingCount) : []
      };

      $("submitBtn").disabled = true;
      $("comingNextBtn").disabled = true;

      postJson("submit", payload)
        .then(function(res){
          $("submitBtn").disabled = false;
          $("comingNextBtn").disabled = false;

          if (!res || res.ok === false) {
            showErr($("submitErr"), (res && res.error) ? res.error : "Unable to submit. Please try again.");
            return;
          }

          if (res.locked) {
            go("stepLocked", "RSVP", "RSVP already received.");
            return;
          }

          if (state.status === "Declined") {
            go("stepDeclined", "RSVP", "Response recorded.");
            return;
          }

          var msg = "RSVP received for " + state.attendingCount + (state.attendingCount === 1 ? " guest." : " guests.");
          setText($("thanksLine"), msg);
          go("stepThanks", "RSVP", "Response recorded.");
        })
        .catch(function(){
          $("submitBtn").disabled = false;
          $("comingNextBtn").disabled = false;
          showErr($("submitErr"), "Network error. Please try again.");
        });
    }

    /* =========================
       Bind events
    ========================== */
    $("closeBtn").addEventListener("click", closeRSVP);
    $("thanksCloseBtn").addEventListener("click", closeRSVP);
    $("declineCloseBtn").addEventListener("click", closeRSVP);
    $("lockedCloseBtn").addEventListener("click", closeRSVP);

    $("startOverBtn").addEventListener("click", function(){ resetState(); });

    $("findBtn").addEventListener("click", startFind);
    $("nameInput").addEventListener("keydown", function(e){
      if (e.key === "Enter") startFind();
    });

    $("pickBackBtn").addEventListener("click", function(){
      go("stepFind", "RSVP", "Find your invite to get started.");
    });

    $("btnYes").addEventListener("click", function(){
      state.status = "Attending";
      setYesNo("Yes");
      show($("attendingBox"));
      clearErr($("comingErr"));
      state.attendingCount = parseInt($("countSelect").value, 10) || 1;
      buildAttendeeInputs(state.attendingCount);
    });

    $("btnNo").addEventListener("click", function(){
      state.status = "Declined";
      setYesNo("No");
      hide($("attendingBox"));
      clearErr($("comingErr"));
    });

    $("countSelect").addEventListener("change", function(){
      var n = parseInt($("countSelect").value, 10) || 1;
      state.attendingCount = n;
      buildAttendeeInputs(n);
    });

    $("comingBackBtn").addEventListener("click", function(){
      go("stepFind", "RSVP", "Find your invite to get started.");
    });

    $("comingNextBtn").addEventListener("click", comingNext);

    $("stepTranspo").querySelectorAll(".btn.pill[data-transpo]").forEach(function(btn){
      btn.addEventListener("click", function(){
        setTranspo(btn.getAttribute("data-transpo"));
        clearErr($("transpoErr"));
      });
    });

    $("transpoBackBtn").addEventListener("click", function(){
      go("stepComing", "RSVP", "Will you be attending?");
    });

    $("transpoNextBtn").addEventListener("click", transpoNext);

    $("phoneBackBtn").addEventListener("click", function(){
      go("stepTranspo", "RSVP", "Transportation details");
    });

    $("phoneInput").addEventListener("input", function(){
      setPhoneFromInput();
      hide($("phoneErr"));
    });

    $("phoneInput").addEventListener("blur", function(){
      validatePhone(false);
    });

    $("phoneNextBtn").addEventListener("click", phoneNext);

    $("notesBackBtn").addEventListener("click", function(){
      go("stepPhone", "RSVP", "Contact number");
    });

    $("submitBtn").addEventListener("click", submitRSVP);

    // Click outside modal closes (same as Close)
    $("overlay").addEventListener("click", function(e){
      if (e.target === $("overlay")) closeRSVP();
    });

    // Esc closes (nice on desktop)
    document.addEventListener("keydown", function(e){
      if (e.key === "Escape") closeRSVP();
    });

    // Init
    resetState();
  </script>
</body>
</html>
