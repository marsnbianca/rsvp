<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSVP</title>

  <style>
    :root{
      --bg: rgba(15, 15, 20, 0.55);
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 24px 80px rgba(0,0,0,.18);
      --radius: 18px;

      /* Distinct button palettes */
      --primary: #111827;
      --primaryText: #ffffff;
      --primaryHover: #0b1220;

      --secondary: #f3f4f6;
      --secondaryText: #111827;
      --secondaryHover: #e5e7eb;

      /* Choice buttons (selectable) */
      --choiceBg: #ffffff;
      --choiceText: #111827;
      --choiceBorder: #e5e7eb;
      --choiceHover: #f9fafb;
      --choiceActiveBg: #111827;
      --choiceActiveText: #ffffff;
      --choiceActiveBorder: #111827;

      --danger: #b91c1c;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: transparent;
      color: var(--text);
      text-align: center;
    }

    #overlay{
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      box-sizing: border-box;
    }

    #modal{
      width: min(520px, calc(100vw - 36px));
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    header{
      padding: 18px 18px 12px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .title{
      margin:0;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: .2px;
      padding: 0 44px;
    }

    .subtitle{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      padding: 0 44px;
    }

    .xBtn{
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
      color: var(--text);
      user-select: none;
    }
    .xBtn:hover{ background: #f9fafb; }
    .xHidden{ display:none !important; }

    main{ padding: 16px 18px 18px; }

    .col{ display:flex; flex-direction: column; gap: 12px; align-items: center; }

    label{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      display:block;
      text-align: center;
    }

    input, textarea, select{
      width: min(420px, 100%);
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
      color: var(--text);
      text-align: center;
    }

    textarea{ min-height: 96px; resize: vertical; }

    .help{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
      text-align: center;
      max-width: 420px;
    }

    .err{
      color: var(--danger);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
      text-align: center;
      max-width: 420px;
    }

    .hidden{ display:none !important; }

    .btn{
      appearance: none;
      border: 0;
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition: background 160ms ease, transform 120ms ease, opacity 160ms ease;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: var(--primary);
      color: var(--primaryText);
      min-width: 180px;
    }
    .btn.primary:hover{ background: var(--primaryHover); }

    .btn.secondary{
      background: var(--secondary);
      color: var(--secondaryText);
      border: 1px solid var(--border);
      min-width: 140px;
    }
    .btn.secondary:hover{ background: var(--secondaryHover); }

    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    .choiceBtn{
      width: min(320px, 100%);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid var(--choiceBorder);
      background: var(--choiceBg);
      color: var(--choiceText);
      text-align: center;
      display: block;
      transition: background 160ms ease, color 160ms ease, border-color 160ms ease, transform 120ms ease;
    }
    .choiceBtn:hover{ background: var(--choiceHover); }
    .choiceBtn:active{ transform: translateY(1px); }
    .choiceBtn.active{
      background: var(--choiceActiveBg);
      color: var(--choiceActiveText);
      border-color: var(--choiceActiveBorder);
    }

    .footer{
      display:flex;
      justify-content: center;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
      width: 100%;
    }

    .contactLine{
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      text-align: center;
      max-width: 420px;
    }

    /* Loading overlay */
    #loadingMask{
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5;
      backdrop-filter: blur(2px);
    }
    #loadingMask.show{ display: flex; }

    .spinner{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 3px solid rgba(17,24,39,0.18);
      border-top-color: rgba(17,24,39,0.90);
      animation: spin 0.85s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div id="overlay" role="dialog" aria-modal="true" aria-label="RSVP">
    <div id="modal">
      <div id="loadingMask" aria-hidden="true">
        <div class="spinner" role="status" aria-label="Loading"></div>
      </div>

      <header>
        <h1 class="title" id="headerTitle">RSVP</h1>
        <p class="subtitle" id="headerSubtitle">Type your name to begin.</p>
        <button class="xBtn" id="xBtn" type="button" aria-label="Close">Ã—</button>
      </header>

      <main>
        <!-- honeypot (hidden) -->
        <input id="hpInput" type="text" tabindex="-1" autocomplete="off" style="display:none;" />

        <!-- FIND -->
        <section id="stepFind" class="col">
          <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <label for="nameInput">Name</label>
            <input id="nameInput" type="text" inputmode="text" autocomplete="name" placeholder="First name, last name, or both" />
            <div class="help">Tip: try first + last name if you donâ€™t see your invite.</div>
            <div id="findErr" class="err hidden"></div>
          </div>

          <div class="footer">
            <button class="btn primary" id="findBtn" type="button">Find</button>
          </div>
        </section>

        <!-- PICK -->
        <section id="stepPick" class="col hidden">
          <div class="help" id="pickSummary" style="margin-top:0;"></div>
          <div id="pickList" class="col" style="width:100%;"></div>
          <div id="pickErr" class="err hidden"></div>

          <div class="footer">
            <button class="btn secondary" id="pickNotMeBtn" type="button">Not me</button>
            <button class="btn secondary" id="pickBackBtn" type="button">Back</button>
          </div>
        </section>

        <!-- CONTACT (Not me) -->
        <section id="stepContact" class="col hidden">
          <div style="font-size:16px; font-weight:600;">Canâ€™t find your invite?</div>
          <div class="help">Please contact Bianca &amp; Mars (or the coordinator) so we can help.</div>
          <div class="contactLine" id="contactLineContact"></div>

          <div class="footer">
            <button class="btn secondary" id="contactCloseBtn" type="button">Close</button>
          </div>
        </section>

        <!-- COMING -->
        <section id="stepComing" class="col hidden">
          <div class="col" style="width:100%;">
            <div class="help" style="margin-top:0;">Will you be attending?</div>

            <button class="choiceBtn" id="btnYes" type="button">Yes</button>
            <button class="choiceBtn" id="btnNo" type="button">No</button>

            <div id="comingErr" class="err hidden"></div>
          </div>

          <div id="attendingBox" class="col hidden" style="width:100%;">
            <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
              <label for="countSelect">Guests attending</label>
              <select id="countSelect"></select>
              <div class="help">Max: <span id="maxSeatsLabel">4</span></div>
            </div>

            <div id="attendeeInputs" class="col" style="width:100%;"></div>
          </div>

          <div class="footer">
            <button class="btn secondary" id="comingBackBtn" type="button">Back</button>
            <button class="btn primary" id="comingNextBtn" type="button">Next</button>
          </div>
        </section>

        <!-- TRANSPO -->
        <section id="stepTranspo" class="col hidden">
          <div class="help" style="margin-top:0;">Transportation needed?</div>

          <button class="choiceBtn" id="transpoYes" type="button">Yes</button>
          <button class="choiceBtn" id="transpoNo" type="button">No</button>

          <div id="transpoErr" class="err hidden"></div>

          <div class="footer">
            <button class="btn secondary" id="transpoBackBtn" type="button">Back</button>
            <button class="btn primary" id="transpoNextBtn" type="button">Next</button>
          </div>
        </section>

        <!-- PHONE -->
        <section id="stepPhone" class="col hidden">
          <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <label for="phoneInput">Phone number</label>
            <input id="phoneInput" type="tel" inputmode="numeric" autocomplete="tel" placeholder="09XX XXX XXXX" maxlength="13" />
            <div class="help">You can type without spaces â€” weâ€™ll format it.</div>
            <div id="phoneErr" class="err hidden"></div>
          </div>

          <div class="footer">
            <button class="btn secondary" id="phoneBackBtn" type="button">Back</button>
            <button class="btn primary" id="phoneNextBtn" type="button">Next</button>
          </div>
        </section>

        <!-- NOTES -->
        <section id="stepNotes" class="col hidden">
          <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <label for="notesInput">Notes (optional)</label>
            <textarea id="notesInput" placeholder="Dietary restrictions, questions, anything to share"></textarea>
          </div>

          <div class="footer">
            <button class="btn secondary" id="notesBackBtn" type="button">Back</button>
            <button class="btn primary" id="submitBtn" type="button">Submit</button>
          </div>

          <div id="submitErr" class="err hidden"></div>
        </section>

        <!-- THANKS -->
        <section id="stepThanks" class="col hidden">
          <div style="font-size:16px; font-weight:700;">Thank you!</div>
          <div class="help" id="thanksLine">RSVP received.</div>
          <div class="help">See you there. ðŸ’›</div>
          <div class="contactLine" id="contactLine"></div>

          <div class="footer">
            <button class="btn secondary" id="thanksCloseBtn" type="button">Close</button>
          </div>
        </section>

        <!-- DECLINED -->
        <section id="stepDeclined" class="col hidden">
          <div style="font-size:16px; font-weight:700;">Thank you!</div>
          <div class="help">Your response has been recorded.</div>
          <div class="contactLine" id="contactLine2"></div>

          <div class="footer">
            <button class="btn secondary" id="declineCloseBtn" type="button">Close</button>
          </div>
        </section>

        <!-- LOCKED -->
        <section id="stepLocked" class="col hidden">
          <div style="font-size:16px; font-weight:600;">RSVP already received</div>
          <div class="help">To update, please contact Bianca &amp; Mars (or the coordinator).</div>
          <div class="contactLine" id="contactLine3"></div>

          <div class="footer">
            <button class="btn secondary" id="lockedCloseBtn" type="button">Close</button>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script>
    var CONFIG = {
      webAppUrl: "https://script.google.com/macros/s/AKfycbxNMaS4bQoEICGBUa6uH5qL4BOGjhK_f1CajHkSWJkgDe_tTrbAM0KyWHKQd0YKQ4BMxA/exec",
      maxSeatsCap: 4,
      contactLineText:
        "Need help? Contact Bianca & Mars (or the coordinator) at +63 XXX XXX XXXX (WhatsApp/Viber)."
    };

    function $(id){ return document.getElementById(id); }
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setText(el, txt){ el.textContent = txt; }
    function showErr(el, msg){ setText(el, msg); show(el); }
    function clearErr(el){ setText(el, ""); hide(el); }

    function showLoading(on){
      $("loadingMask").classList.toggle("show", !!on);
    }

    function normalizeSpaces_(s){ return (s || "").replace(/\s+/g, " ").trim(); }

    function titleCaseName_(s){
      s = normalizeSpaces_(s).toLowerCase();
      var out = "";
      var capNext = true;
      for (var i = 0; i < s.length; i++){
        var ch = s[i];
        if (capNext && /[a-z]/.test(ch)) { out += ch.toUpperCase(); capNext = false; }
        else out += ch;
        if (ch === " " || ch === "-" || ch === "'") capNext = true;
      }
      return out;
    }

    function hideAllSteps(){
      hide($("stepFind"));
      hide($("stepPick"));
      hide($("stepContact"));
      hide($("stepComing"));
      hide($("stepTranspo"));
      hide($("stepPhone"));
      hide($("stepNotes"));
      hide($("stepThanks"));
      hide($("stepDeclined"));
      hide($("stepLocked"));
    }

    function setXVisible_(visible){
      if (visible) $("xBtn").classList.remove("xHidden");
      else $("xBtn").classList.add("xHidden");
    }

    var navStack = [];

    function go(stepId, title, subtitle, options){
      options = options || {};
      if (!options.noHistory) navStack.push(stepId);

      hideAllSteps();
      show($(stepId));

      if (title) setText($("headerTitle"), title);
      if (subtitle) setText($("headerSubtitle"), subtitle);

      var endScreens = (stepId === "stepThanks" || stepId === "stepDeclined" || stepId === "stepLocked" || stepId === "stepContact");
      setXVisible_(!endScreens);

      window.scrollTo(0,0);
    }

    function goBackOne(){
      if (navStack.length > 0) navStack.pop();
      var prev = navStack.length ? navStack[navStack.length - 1] : "stepFind";

      hideAllSteps();
      show($(prev));

      var endScreens = (prev === "stepThanks" || prev === "stepDeclined" || prev === "stepLocked" || prev === "stepContact");
      setXVisible_(!endScreens);

      if (prev === "stepFind") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Type your name to begin."); }
      if (prev === "stepPick") { setText($("headerTitle"), "Confirm"); setText($("headerSubtitle"), "Select your invite."); }
      if (prev === "stepComing") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Attendance"); }
      if (prev === "stepTranspo") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Transportation"); }
      if (prev === "stepPhone") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Contact"); }
      if (prev === "stepNotes") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Notes"); }

      window.scrollTo(0,0);
    }

    function getClientId_(){
      try {
        var k = "rsvp_client_id_v1";
        var v = localStorage.getItem(k);
        if (v) return v;
        v = "c_" + Math.random().toString(16).slice(2) + "_" + Date.now();
        localStorage.setItem(k, v);
        return v;
      } catch (e) {
        return "anon";
      }
    }
    var CLIENT_ID = getClientId_();

    function postJson(action, payload){
      var base = Object.assign(
        { action: action, client_id: CLIENT_ID, hp: String($("hpInput").value || "").trim() },
        payload || {}
      );

      showLoading(true);
      return fetch(CONFIG.webAppUrl, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(base)
      }).then(function(r){
        return r.text().then(function(t){
          showLoading(false);
          try { return JSON.parse(t); }
          catch(e){ return { ok:false, error:"Bad response from server." }; }
        });
      }).catch(function(err){
        showLoading(false);
        throw err;
      });
    }

    function getParentOrigin_(){
      try {
        if (document.referrer) return new URL(document.referrer).origin;
      } catch (e) {}
      return "*";
    }

    function closeRSVP(){
      var targetOrigin = getParentOrigin_();
      if (window.parent && window.parent !== window) {
        try { window.parent.postMessage("RSVP:CLOSE", targetOrigin); }
        catch (e) { window.parent.postMessage("RSVP:CLOSE", "*"); }
        return;
      }
      if (window.opener && !window.opener.closed) {
        window.close();
        return;
      }
      window.location.href = "/";
    }

    /* Double-click outside closes (overlay area only) */
    $("overlay").addEventListener("dblclick", function(e){
      if (e && e.target === $("overlay")) closeRSVP();
    });

    /* Phone: display with spaces, accept without spaces */
    function digitsOnly(s){ return (s || "").replace(/\D+/g, ""); }

    function formatPHVisibleFromDigits(d){
      var x = (d || "").slice(0, 11);
      var a = x.slice(0, 4);
      var b = x.slice(4, 7);
      var c = x.slice(7, 11);
      var out = a;
      if (b.length) out += " " + b;
      if (c.length) out += " " + c;
      return out.trim();
    }

    function isValidPHVisible(v){
      return /^09\d{2}\s\d{3}\s\d{4}$/.test(String(v || "").trim());
    }

    function setPhoneFromInput(){
      var d = digitsOnly($("phoneInput").value);
      // allow +63 / 63 entry
      if (d.indexOf("63") === 0 && d.length >= 12) d = "0" + d.slice(2);
      if (d.indexOf("9") === 0 && d.length === 10) d = "0" + d;

      d = d.slice(0, 11);
      var visible = formatPHVisibleFromDigits(d);
      $("phoneInput").value = visible;
      return visible;
    }

    function validatePhone(showMessage){
      var visible = setPhoneFromInput();
      if (!visible) {
        if (showMessage) showErr($("phoneErr"), "Phone number is required.");
        return { ok:false, kind:"required", visible:visible };
      }
      if (!isValidPHVisible(visible)) {
        if (showMessage) showErr($("phoneErr"), "Please type 11 digits starting with 09.");
        return { ok:false, kind:"invalid", visible:visible };
      }
      clearErr($("phoneErr"));
      return { ok:true, kind:"ok", visible:visible };
    }

    var state = {
      matches: [],
      selected: null,
      inviteId: null,
      status: null,
      attendingCount: 0,
      attendees: [],
      transportation: "",
      phoneVisible: "",
      notes: ""
    };

    function buildCountSelect(max){
      var sel = $("countSelect");
      sel.innerHTML = "";
      var cap = Math.max(1, Math.min(CONFIG.maxSeatsCap, max || CONFIG.maxSeatsCap));
      setText($("maxSeatsLabel"), String(cap));
      for (var i = 1; i <= cap; i++){
        var opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        sel.appendChild(opt);
      }
      sel.value = "1";
    }

    function buildAttendeeInputs(n){
      var box = $("attendeeInputs");
      box.innerHTML = "";
      for (var i = 0; i < n; i++){
        var wrap = document.createElement("div");
        wrap.style.width = "100%";
        wrap.style.display = "flex";
        wrap.style.flexDirection = "column";
        wrap.style.alignItems = "center";

        var lab = document.createElement("label");
        lab.textContent = (i === 0) ? "Guest name" : ("Guest " + (i+1) + " name");

        var inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "Full name";
        inp.dataset.idx = String(i);

        inp.addEventListener("input", function(e){
          var idx = parseInt(e.target.dataset.idx, 10);
          state.attendees[idx] = normalizeSpaces_(e.target.value);
        });

        inp.addEventListener("blur", function(e){
          var idx = parseInt(e.target.dataset.idx, 10);
          var fixed = titleCaseName_(e.target.value);
          e.target.value = fixed;
          state.attendees[idx] = fixed;
        });

        wrap.appendChild(lab);
        wrap.appendChild(inp);
        box.appendChild(wrap);
      }
      state.attendees = new Array(n).fill("");
    }

    function setPickSummary_(n){
      setText($("pickSummary"), "We found " + n + " invite" + (n === 1 ? "" : "s") + ". Tap your name to continue.");
    }

    function renderPickList(matches){
      var list = $("pickList");
      list.innerHTML = "";

      matches.forEach(function(m, idx){
        var btn = document.createElement("button");
        btn.type = "button";
        btn.className = "choiceBtn";
        btn.textContent = m.display_name || m.name || "Select";

        btn.addEventListener("click", function(){
          // mark active (visual)
          var buttons = list.querySelectorAll(".choiceBtn");
          for (var i = 0; i < buttons.length; i++) buttons[i].classList.remove("active");
          btn.classList.add("active");

          selectMatch(m);
        });

        list.appendChild(btn);
      });
    }

    function resetState(){
      state = { matches:[], selected:null, inviteId:null, status:null, attendingCount:0, attendees:[], transportation:"", phoneVisible:"", notes:"" };
      $("nameInput").value = "";
      $("notesInput").value = "";
      $("phoneInput").value = "";
      $("hpInput").value = "";

      clearErr($("findErr"));
      clearErr($("pickErr"));
      clearErr($("comingErr"));
      clearErr($("transpoErr"));
      clearErr($("phoneErr"));
      clearErr($("submitErr"));

      setText($("contactLine"), CONFIG.contactLineText);
      setText($("contactLine2"), CONFIG.contactLineText);
      setText($("contactLine3"), CONFIG.contactLineText);
      setText($("contactLineContact"), CONFIG.contactLineText);

      $("btnYes").classList.remove("active");
      $("btnNo").classList.remove("active");
      $("transpoYes").classList.remove("active");
      $("transpoNo").classList.remove("active");
      hide($("attendingBox"));

      navStack = [];
      go("stepFind", "RSVP", "Type your name to begin.", { noHistory: false });
    }

    function startFind(){
      clearErr($("findErr"));
      var q = normalizeSpaces_($("nameInput").value);
      if (!q){ showErr($("findErr"), "Please enter your name."); return; }

      $("findBtn").disabled = true;
      postJson("find", { name: q })
        .then(function(res){
          $("findBtn").disabled = false;

          if (!res || res.ok === false){
            showErr($("findErr"), (res && res.error) ? res.error : "Something went wrong. Please try again.");
            return;
          }

          var matches = res.matches || [];
          state.matches = matches;

          if (matches.length === 0){
            showErr($("findErr"), "No match found. Please try a different name.");
            return;
          }

          setPickSummary_(matches.length);
          renderPickList(matches);
          clearErr($("pickErr"));
          go("stepPick", "Confirm", "Select your invite.");
        })
        .catch(function(){
          $("findBtn").disabled = false;
          showErr($("findErr"), "Network error. Please try again.");
        });
    }

    function selectMatch(match){
      var inviteId = match.invite_id || match.id || match.key;
      if (!inviteId){ showErr($("pickErr"), "Missing invite ID. Please try again."); return; }

      state.inviteId = inviteId;

      postJson("get", { invite_id: inviteId })
        .then(function(res){
          if (!res || res.ok === false){
            showErr($("pickErr"), (res && res.error) ? res.error : "Unable to load. Please try again.");
            return;
          }

          if (res.locked){
            go("stepLocked", "RSVP", "Already received.");
            return;
          }

          state.selected = res.invite || match;

          var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
          maxSeats = Math.max(1, maxSeats);

          buildCountSelect(maxSeats);

          state.status = null;
          $("btnYes").classList.remove("active");
          $("btnNo").classList.remove("active");
          clearErr($("comingErr"));

          state.transportation = "";
          $("transpoYes").classList.remove("active");
          $("transpoNo").classList.remove("active");
          clearErr($("transpoErr"));

          if (maxSeats <= 1) {
            hide($("attendingBox"));
            state.attendingCount = 1;
            state.attendees = [ titleCaseName_(state.selected.display_name || state.selected.name || "") ];
          } else {
            show($("attendingBox"));
            state.attendingCount = 1;
            buildAttendeeInputs(1);
          }

          go("stepComing", "RSVP", "Attendance");
        })
        .catch(function(){
          showErr($("pickErr"), "Network error. Please try again.");
        });
    }

    function comingNext(){
      clearErr($("comingErr"));

      if (!state.status){
        showErr($("comingErr"), "Please select Yes or No.");
        return;
      }

      if (state.status === "Declined"){
        submitRSVP();
        return;
      }

      var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
      maxSeats = Math.max(1, maxSeats);

      if (maxSeats <= 1) {
        state.attendingCount = 1;
        state.attendees = [ titleCaseName_(state.selected.display_name || state.selected.name || "") ];
      } else {
        var chosen = parseInt($("countSelect").value, 10) || 1;
        chosen = Math.max(1, Math.min(chosen, maxSeats));
        state.attendingCount = chosen;

        for (var i = 0; i < state.attendingCount; i++){
          state.attendees[i] = titleCaseName_(state.attendees[i]);
          if (!state.attendees[i]) {
            showErr($("comingErr"), "Please enter all guest names.");
            return;
          }
        }
      }

      go("stepTranspo", "RSVP", "Transportation");
    }

    function transpoNext(){
      clearErr($("transpoErr"));
      if (!state.transportation){
        showErr($("transpoErr"), "Please select Yes or No.");
        return;
      }
      go("stepPhone", "RSVP", "Contact");
    }

    function phoneNext(){
      var v = validatePhone(true);
      if (!v.ok) return;
      state.phoneVisible = v.visible;
      go("stepNotes", "RSVP", "Notes");
    }

    function submitRSVP(){
      clearErr($("submitErr"));

      var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
      maxSeats = Math.max(1, maxSeats);

      if (state.status === "Attending"){
        state.attendees = (state.attendees || []).map(function(nm){ return titleCaseName_(nm); }).filter(Boolean);
        state.attendingCount = Math.max(1, Math.min(state.attendingCount || 1, maxSeats, state.attendees.length || 1));

        var v = validatePhone(true);
        if (!v.ok){
          showErr($("submitErr"), "Please enter a valid phone number.");
          return;
        }
        state.phoneVisible = v.visible;
      } else {
        state.phoneVisible = "";
      }

      state.notes = normalizeSpaces_($("notesInput").value);

      var payload = {
        invite_id: state.inviteId,
        status: state.status,
        attending_count: state.status === "Attending" ? state.attendingCount : 0,
        phone: state.phoneVisible || "",
        transportation: state.status === "Attending" ? (state.transportation || "") : "",
        notes: state.notes || "",
        attendees: state.status === "Attending" ? state.attendees.slice(0, state.attendingCount) : []
      };

      $("submitBtn").disabled = true;
      $("comingNextBtn").disabled = true;

      postJson("submit", payload)
        .then(function(res){
          $("submitBtn").disabled = false;
          $("comingNextBtn").disabled = false;

          if (!res || res.ok === false){
            showErr($("submitErr"), (res && res.error) ? res.error : "Unable to submit. Please try again.");
            return;
          }

          if (res.locked){
            go("stepLocked", "RSVP", "Already received.");
            return;
          }

          if (state.status === "Declined"){
            go("stepDeclined", "RSVP", "Recorded.");
            return;
          }

          setText($("thanksLine"), "Recorded for " + state.attendingCount + (state.attendingCount === 1 ? " guest." : " guests."));
          go("stepThanks", "RSVP", "Recorded.");
        })
        .catch(function(){
          $("submitBtn").disabled = false;
          $("comingNextBtn").disabled = false;
          showErr($("submitErr"), "Network error. Please try again.");
        });
    }

    // Close buttons
    $("xBtn").addEventListener("click", closeRSVP);
    $("thanksCloseBtn").addEventListener("click", closeRSVP);
    $("declineCloseBtn").addEventListener("click", closeRSVP);
    $("lockedCloseBtn").addEventListener("click", closeRSVP);
    $("contactCloseBtn").addEventListener("click", closeRSVP);

    // ESC close
    window.addEventListener("keydown", function(e){
      if (e && e.key === "Escape") closeRSVP();
    });

    // Navigation
    $("findBtn").addEventListener("click", startFind);
    $("nameInput").addEventListener("keydown", function(e){ if (e.key === "Enter") startFind(); });

    $("pickBackBtn").addEventListener("click", goBackOne);

    $("pickNotMeBtn").addEventListener("click", function(){
      // most likely nickname / wrong spelling / not invited
      navStack = [];
      go("stepContact", "RSVP", "Help", { noHistory:false });
    });

    $("comingBackBtn").addEventListener("click", goBackOne);
    $("transpoBackBtn").addEventListener("click", goBackOne);
    $("phoneBackBtn").addEventListener("click", goBackOne);
    $("notesBackBtn").addEventListener("click", goBackOne);

    // Choice buttons (active state)
    $("btnYes").addEventListener("click", function(){
      state.status = "Attending";
      $("btnYes").classList.add("active");
      $("btnNo").classList.remove("active");
      clearErr($("comingErr"));

      var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
      maxSeats = Math.max(1, maxSeats);

      if (maxSeats <= 1) {
        hide($("attendingBox"));
        state.attendingCount = 1;
        state.attendees = [ titleCaseName_(state.selected.display_name || state.selected.name || "") ];
      } else {
        show($("attendingBox"));
        state.attendingCount = parseInt($("countSelect").value, 10) || 1;
        state.attendingCount = Math.max(1, Math.min(state.attendingCount, maxSeats));
        buildAttendeeInputs(state.attendingCount);
      }
    });

    $("btnNo").addEventListener("click", function(){
      state.status = "Declined";
      $("btnNo").classList.add("active");
      $("btnYes").classList.remove("active");
      hide($("attendingBox"));
      clearErr($("comingErr"));
    });

    $("countSelect").addEventListener("change", function(){
      var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
      maxSeats = Math.max(1, maxSeats);

      var n = parseInt($("countSelect").value, 10) || 1;
      n = Math.max(1, Math.min(n, maxSeats));
      state.attendingCount = n;
      buildAttendeeInputs(n);
    });

    $("comingNextBtn").addEventListener("click", comingNext);

    $("transpoYes").addEventListener("click", function(){
      state.transportation = "Yes";
      $("transpoYes").classList.add("active");
      $("transpoNo").classList.remove("active");
      clearErr($("transpoErr"));
    });

    $("transpoNo").addEventListener("click", function(){
      state.transportation = "No";
      $("transpoNo").classList.add("active");
      $("transpoYes").classList.remove("active");
      clearErr($("transpoErr"));
    });

    $("transpoNextBtn").addEventListener("click", transpoNext);

    $("phoneInput").addEventListener("input", function(){
      setPhoneFromInput();
      hide($("phoneErr"));
    });

    $("phoneInput").addEventListener("blur", function(){ validatePhone(false); });
    $("phoneNextBtn").addEventListener("click", phoneNext);

    $("submitBtn").addEventListener("click", submitRSVP);

    // Contact lines
    setText($("contactLine"), CONFIG.contactLineText);
    setText($("contactLine2"), CONFIG.contactLineText);
    setText($("contactLine3"), CONFIG.contactLineText);
    setText($("contactLineContact"), CONFIG.contactLineText);

    resetState();
  </script>
</body>
</html>
