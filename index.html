<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSVP</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --line: rgba(0,0,0,0.12);
      --btn: #111111;
      --btnfg: #ffffff;
      --btn2: #f2f2f2;
      --err: #b00020;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: transparent;
      color: var(--fg);
    }
    .overlay {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .modal {
      width: min(520px, 100%);
      background: var(--bg);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .header {
      padding: 18px 18px 10px 18px;
      border-bottom: 1px solid var(--line);
    }
    .title {
      margin: 0;
      font-size: 18px;
      line-height: 1.2;
      font-weight: 650;
    }
    .sub {
      margin: 8px 0 0 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .content { padding: 16px 18px 18px 18px; }
    .row { display: grid; gap: 10px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="tel"], textarea, select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
      background: #fff;
      color: var(--fg);
    }
    textarea { min-height: 90px; resize: vertical; }
    .btns { display: flex; gap: 10px; margin-top: 14px; }
    button {
      appearance: none;
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .primary { background: var(--btn); color: var(--btnfg); }
    .secondary { background: var(--btn2); color: var(--fg); border-color: var(--line); }
    .muted { color: var(--muted); font-size: 13px; line-height: 1.35; }
    .error { color: var(--err); font-size: 13px; line-height: 1.35; }

    .list { border: 1px solid var(--line); border-radius: 12px; overflow: hidden; }
    .item {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
    }
    .item:last-child { border-bottom: none; }
    .item:hover { background: rgba(0,0,0,0.03); }
    .itemName { font-size: 15px; }
    .tag { font-size: 12px; color: var(--muted); }

    .pillRow { display: flex; gap: 10px; flex-wrap: wrap; }
    .pill {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .pill.active {
      background: rgba(0,0,0,0.06);
      border-color: rgba(0,0,0,0.18);
    }

    .inline {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 10px;
      align-items: center;
    }

    .loading {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: rgba(0,0,0,0.25);
      animation: pulse 1s infinite ease-in-out;
    }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes pulse {
      0%, 100% { transform: scale(0.9); opacity: 0.45; }
      50% { transform: scale(1.15); opacity: 1; }
    }

    .closeWrap {
      display: flex;
      justify-content: flex-end;
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,0.02);
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="modal" id="modal">
      <div class="header">
        <h1 class="title" id="title">Find your invite</h1>
        <p class="sub" id="subtitle">Type the name on the invitation, then pick your match to continue.</p>
      </div>
      <div class="content" id="content"></div>
      <div class="closeWrap" id="closeWrap" style="display:none;">
        <button class="secondary" id="closeBtn" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
  const CONFIG = {
    webAppUrl: "https://script.google.com/macros/s/AKfycbxNMaS4bQoEICGBUa6uH5qL4BOGjhK_f1CajHkSWJkgDe_tTrbAM0KyWHKQd0YKQ4BMxA/exec",
    maxSeatsCap: 4
  };

  const state = {
    step: "find",
    loading: false,
    error: "",
    contactLine: "",
    nameQuery: "",
    matches: [],
    selected: null,
    invite: null,

    attending: null,          // "yes" | "no"
    attendingCount: 1,
    attendeeNames: [],        // attendee #1..#N

    transportation: null,     // "Yes" | "No"
    phoneDigits: "",          // raw digits for 09xxxxxxxxx
    notes: ""
  };

  const elTitle = document.getElementById("title");
  const elSubtitle = document.getElementById("subtitle");
  const elContent = document.getElementById("content");
  const elCloseWrap = document.getElementById("closeWrap");
  const elCloseBtn = document.getElementById("closeBtn");

  elCloseBtn.addEventListener("click", closeModal);

  function setHeader(title, subtitle) {
    elTitle.textContent = title;
    elSubtitle.textContent = subtitle || "";
  }

  function errorEl(msg) {
    const err = document.createElement("div");
    err.className = "error";
    err.textContent = msg;
    return err;
  }

  function pill(text, active, onClick) {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "pill" + (active ? " active" : "");
    b.textContent = text;
    b.addEventListener("click", onClick);
    return b;
  }

  function clamp(n, a, b) {
    const x = Number(n);
    if (!Number.isFinite(x)) return a;
    return Math.min(Math.max(x, a), b);
  }

  function loadingRow() {
    const div = document.createElement("div");
    div.className = "loading";
    div.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span><span>Loading…</span>`;
    return div;
  }

  // CORS-safe request (no preflight)
  async function api(action, payload) {
    const res = await fetch(CONFIG.webAppUrl, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action, ...(payload || {}) })
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch (e) { return { ok: false, error: "Invalid server response.", raw: text }; }
  }

  function syncAttendeeNames_(maxSeats) {
    const cnt = clamp(state.attendingCount || 1, 1, maxSeats);
    state.attendingCount = cnt;

    const arr = Array.isArray(state.attendeeNames) ? state.attendeeNames.slice(0, cnt) : [];
    while (arr.length < cnt) arr.push("");
    state.attendeeNames = arr;
  }

  function formatPH09_(digits) {
    const d = (digits || "").replace(/[^\d]/g, "").slice(0, 11);
    const p1 = d.slice(0, 4);
    const p2 = d.slice(4, 7);
    const p3 = d.slice(7, 11);
    if (d.length <= 4) return p1;
    if (d.length <= 7) return `${p1} ${p2}`;
    return `${p1} ${p2} ${p3}`;
  }

  function isValidPH09_(digits) {
    const d = (digits || "").replace(/[^\d]/g, "");
    return d.length === 11 && d.startsWith("09");
  }

  function toE164From09_(digits09) {
    const d = (digits09 || "").replace(/[^\d]/g, "");
    if (d.length !== 11 || !d.startsWith("09")) return "";
    return "+63" + d.slice(1); // +63917xxxxxxx
  }

  function render() {
    elContent.innerHTML = "";

    if (state.step === "find") return renderFind();
    if (state.step === "pick") return renderPick();
    if (state.step === "coming") return renderComing();
    if (state.step === "transpo") return renderTranspo();
    if (state.step === "phone") return renderPhone();
    if (state.step === "notes") return renderNotes();
    if (state.step === "locked") return renderLocked();
    if (state.step === "thanks") return renderThanks();

    state.step = "find";
    return renderFind();
  }

  /* ---------------- FIND ---------------- */

  function renderFind() {
    setHeader("Find your invite", "Type the name on the invitation, then pick your match to continue.");
    elCloseWrap.style.display = "none";

    const wrap = document.createElement("div");
    wrap.className = "row";

    const label = document.createElement("label");
    label.textContent = "Guest name";
    wrap.appendChild(label);

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Example: Maria Santos";
    input.value = state.nameQuery;
    input.addEventListener("input", (e) => state.nameQuery = e.target.value);
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") onFind(); });
    wrap.appendChild(input);

    if (state.loading) wrap.appendChild(loadingRow());
    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const btn = document.createElement("button");
    btn.className = "primary";
    btn.type = "button";
    btn.textContent = "Find invite";
    btn.disabled = state.loading;
    btn.onclick = onFind;

    const clear = document.createElement("button");
    clear.className = "secondary";
    clear.type = "button";
    clear.textContent = "Clear";
    clear.disabled = state.loading;
    clear.onclick = () => {
      state.nameQuery = "";
      state.matches = [];
      state.error = "";
      render();
      input.focus();
    };

    btns.appendChild(btn);
    btns.appendChild(clear);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
    setTimeout(() => input.focus(), 0);
  }

  async function onFind() {
    state.error = "";
    const name = (state.nameQuery || "").trim();
    if (!name) { state.error = "Please type a name first."; return render(); }

    state.loading = true;
    render();

    try {
      const data = await api("find", { name });
      state.loading = false;

      if (!data || !data.ok) throw new Error(data?.error || "Search failed.");
      state.contactLine = data.contact_line || "";
      state.matches = Array.isArray(data.matches) ? data.matches : [];

      if (state.matches.length === 0) {
        state.error = "No match found. Try a different spelling, or include a first and last name.";
        return render();
      }

      state.step = "pick";
      render();
    } catch (err) {
      state.loading = false;
      state.error = String(err?.message || err);
      render();
    }
  }

  /* ---------------- PICK ---------------- */

  function renderPick() {
    setHeader("Verify your name", "Select your name to continue.");
    elCloseWrap.style.display = "none";

    const wrap = document.createElement("div");
    wrap.className = "row";

    const list = document.createElement("div");
    list.className = "list";

    state.matches.forEach((m) => {
      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      left.innerHTML = `<div class="itemName"></div><div class="tag"></div>`;
      left.querySelector(".itemName").textContent = m.invite_name || "Unnamed guest";
      const seats = Math.min(Number(m.max_seats || 1), CONFIG.maxSeatsCap);
      left.querySelector(".tag").textContent = seats > 1 ? `Party of ${seats}` : "Single invite";

      const right = document.createElement("div");
      right.className = "tag";
      right.textContent = "Select";

      item.appendChild(left);
      item.appendChild(right);
      item.onclick = () => onPick(m);

      list.appendChild(item);
    });

    wrap.appendChild(list);

    if (state.loading) wrap.appendChild(loadingRow());
    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.type = "button";
    back.textContent = "Back";
    back.disabled = state.loading;
    back.onclick = () => { state.error = ""; state.step = "find"; render(); };

    btns.appendChild(back);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  async function onPick(m) {
    state.error = "";
    state.selected = m;
    state.loading = true;
    render();

    try {
      const data = await api("get", { invite_id: m.invite_id });
      state.loading = false;

      if (!data || !data.ok) throw new Error(data?.error || "Could not load invite.");

      state.contactLine = data.contact_line || state.contactLine || "";
      state.invite = data.invite || null;

      if (!state.invite) throw new Error("Missing invite data.");

      if (state.invite.locked) {
        state.step = "locked";
        return render();
      }

      // reset answers
      state.attending = null;
      state.attendingCount = 1;
      state.attendeeNames = [];
      state.transportation = null;
      state.phoneDigits = "";
      state.notes = "";

      state.step = "coming";
      render();
    } catch (err) {
      state.loading = false;
      state.error = String(err?.message || err);
      render();
    }
  }

  /* ---------------- COMING ---------------- */

  function renderComing() {
    const inviteName = state.invite?.invite_name || "Guest";
    const maxSeats = Math.min(Number(state.invite?.max_seats || 1), CONFIG.maxSeatsCap);

    setHeader("RSVP", `${inviteName}, are you coming?`);
    elCloseWrap.style.display = "none";

    const wrap = document.createElement("div");
    wrap.className = "row";

    const pills = document.createElement("div");
    pills.className = "pillRow";

    pills.appendChild(pill("Yes, I’m coming", state.attending === "yes", () => {
      state.attending = "yes";
      state.attendingCount = clamp(state.attendingCount || 1, 1, maxSeats);
      syncAttendeeNames_(maxSeats);
      state.error = "";
      render();
    }));

    pills.appendChild(pill("No, can’t make it", state.attending === "no", () => {
      state.attending = "no";
      state.attendingCount = 0;
      state.attendeeNames = [];
      state.error = "";
      render();
    }));

    wrap.appendChild(pills);

    if (state.attending === "yes") {
      const label = document.createElement("label");
      label.textContent = "How many people are attending?";
      wrap.appendChild(label);

      const select = document.createElement("select");
      for (let i = 1; i <= maxSeats; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i;
        if (i === Number(state.attendingCount || 1)) opt.selected = true;
        select.appendChild(opt);
      }
      select.onchange = (e) => {
        state.attendingCount = Number(e.target.value);
        syncAttendeeNames_(maxSeats);
        render();
      };
      wrap.appendChild(select);

      syncAttendeeNames_(maxSeats);

      const note = document.createElement("div");
      note.className = "muted";
      note.textContent = "Please enter the full name of each attendee.";
      wrap.appendChild(note);

      for (let i = 0; i < state.attendingCount; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = `Attendee ${i + 1} full name`;
        input.value = state.attendeeNames[i] || "";
        input.oninput = (e) => { state.attendeeNames[i] = e.target.value; };
        wrap.appendChild(input);
      }
    }

    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.onclick = () => { state.error = ""; state.step = "pick"; render(); };

    const next = document.createElement("button");
    next.className = "primary";
    next.textContent = "Next";
    next.onclick = () => {
      state.error = "";

      if (state.attending !== "yes" && state.attending !== "no") {
        state.error = "Please choose Yes or No.";
        return render();
      }

      if (state.attending === "yes") {
        const cleaned = (state.attendeeNames || [])
          .slice(0, state.attendingCount)
          .map(n => (n || "").trim());

        if (cleaned.length !== state.attendingCount || cleaned.some(n => !n)) {
          state.error = "Please fill in all attendee names.";
          return render();
        }
      }

      state.step = "transpo";
      render();
    };

    btns.appendChild(back);
    btns.appendChild(next);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  /* ---------------- TRANSPO ---------------- */

  function renderTranspo() {
    setHeader("Transportation", "Do you need transport arrangements from NAIA to the venue?");
    elCloseWrap.style.display = "none";

    const wrap = document.createElement("div");
    wrap.className = "row";

    const pills = document.createElement("div");
    pills.className = "pillRow";
    pills.appendChild(pill("Yes", state.transportation === "Yes", () => { state.transportation = "Yes"; state.error=""; render(); }));
    pills.appendChild(pill("No", state.transportation === "No", () => { state.transportation = "No"; state.error=""; render(); }));
    wrap.appendChild(pills);

    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.onclick = () => { state.error=""; state.step = "coming"; render(); };

    const next = document.createElement("button");
    next.className = "primary";
    next.textContent = "Next";
    next.onclick = () => {
      state.error = "";
      if (state.transportation !== "Yes" && state.transportation !== "No") {
        state.error = "Please choose Yes or No.";
        return render();
      }
      state.step = "phone";
      render();
    };

    btns.appendChild(back);
    btns.appendChild(next);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  /* ---------------- PHONE ---------------- */

  function renderPhone() {
    setHeader("Mobile number", "Please enter a PH mobile number in the format 09XX XXX XXXX.");
    elCloseWrap.style.display = "none";

    const wrap = document.createElement("div");
    wrap.className = "row";

    const label = document.createElement("label");
    label.textContent = "Mobile number";
    wrap.appendChild(label);

    // This is the actual input. If you still see “no box”, it means this function is not running.
    const input = document.createElement("input");
    input.type = "tel";
    input.inputMode = "numeric";
    input.autocomplete = "tel";
    input.placeholder = "09XX XXX XXXX";
    input.value = formatPH09_(state.phoneDigits);

    input.oninput = (e) => {
      const digits = (e.target.value || "").replace(/[^\d]/g, "").slice(0, 11);
      state.phoneDigits = digits;
      e.target.value = formatPH09_(digits);
    };

    wrap.appendChild(input);

    const hint = document.createElement("div");
    hint.className = "muted";
    hint.textContent = "Example: 0917 123 4567";
    wrap.appendChild(hint);

    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.onclick = () => { state.error=""; state.step = "transpo"; render(); };

    const next = document.createElement("button");
    next.className = "primary";
    next.textContent = "Next";
    next.onclick = () => {
      state.error = "";
      if (!isValidPH09_(state.phoneDigits)) {
        state.error = "Please enter a valid PH mobile number (11 digits, starts with 09).";
        return render();
      }
      state.step = "notes";
      render();
    };

    btns.appendChild(back);
    btns.appendChild(next);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
    setTimeout(() => input.focus(), 0);
  }

  /* ---------------- NOTES ---------------- */

  function renderNotes() {
    setHeader("Additional notes", "Anything you want to share? (Optional)");
    elCloseWrap.style.display = "none";

    const wrap = document.createElement("div");
    wrap.className = "row";

    const label = document.createElement("label");
    label.textContent = "Notes (optional)";
    wrap.appendChild(label);

    const ta = document.createElement("textarea");
    ta.placeholder = "Dietary restrictions, timing notes, special requests, etc.";
    ta.value = state.notes || "";
    ta.oninput = (e) => state.notes = e.target.value;
    wrap.appendChild(ta);

    if (state.loading) wrap.appendChild(loadingRow());
    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.disabled = state.loading;
    back.onclick = () => { state.error=""; state.step = "phone"; render(); };

    const submit = document.createElement("button");
    submit.className = "primary";
    submit.textContent = "Submit RSVP";
    submit.disabled = state.loading;
    submit.onclick = onSubmit;

    btns.appendChild(back);
    btns.appendChild(submit);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  async function onSubmit() {
    state.error = "";

    if (!state.invite?.invite_id) {
      state.error = "Missing invite details. Please start again.";
      state.step = "find";
      return render();
    }

    if (state.attending !== "yes" && state.attending !== "no") {
      state.error = "Please choose Yes or No.";
      state.step = "coming";
      return render();
    }

    if (state.transportation !== "Yes" && state.transportation !== "No") {
      state.error = "Please choose Yes or No for transportation.";
      state.step = "transpo";
      return render();
    }

    if (!isValidPH09_(state.phoneDigits)) {
      state.error = "Please enter a valid PH mobile number (11 digits, starts with 09).";
      state.step = "phone";
      return render();
    }

    let attendees = [];
    let attending_count = 0;

    if (state.attending === "yes") {
      const maxSeats = Math.min(Number(state.invite.max_seats || 1), CONFIG.maxSeatsCap);
      const cnt = clamp(Number(state.attendingCount || 1), 1, maxSeats);

      attendees = (state.attendeeNames || []).slice(0, cnt).map(s => (s || "").trim());
      if (attendees.length !== cnt || attendees.some(x => !x)) {
        state.error = "Please fill in all attendee names.";
        state.step = "coming";
        return render();
      }
      attending_count = cnt;
    }

    const payload = {
      invite_id: state.invite.invite_id,
      attending: state.attending,
      attending_count,
      attendees: state.attending === "yes" ? attendees : [],
      phone: toE164From09_(state.phoneDigits),
      transportation: state.transportation,
      notes: (state.notes || "").trim()
    };

    state.loading = true;
    render();

    try {
      const data = await api("submit", payload);
      state.loading = false;

      if (!data || !data.ok) {
        if (data && data.locked) {
          state.contactLine = data.contact_line || state.contactLine || "";
          state.step = "locked";
          return render();
        }
        throw new Error(data?.error || "Submit failed.");
      }

      state.step = "thanks";
      render();
    } catch (err) {
      state.loading = false;
      state.error = String(err?.message || err);
      render();
    }
  }

  /* ---------------- LOCKED / THANKS ---------------- */

  function renderLocked() {
  setHeader("RSVP already received", "For changes, please contact the coordinator.");
  elCloseWrap.style.display = "flex"; // main close bar button

  const wrap = document.createElement("div");
  wrap.className = "row";

  const msg = document.createElement("div");
  msg.className = "muted";
  msg.textContent = state.contactLine || "Please contact the coordinator for changes.";
  wrap.appendChild(msg);

  const btns = document.createElement("div");
  btns.className = "btns";

  const startOver = document.createElement("button");
  startOver.className = "secondary";
  startOver.textContent = "Start over";
  startOver.onclick = resetAll;

  btns.appendChild(startOver);
  wrap.appendChild(btns);

  elContent.appendChild(wrap);
}

  function renderThanks() {
  setHeader("Thank you!", "See you soon.");
  elCloseWrap.style.display = "flex"; // show the main close bar button only

  const wrap = document.createElement("div");
  wrap.className = "row";

  const btns = document.createElement("div");
  btns.className = "btns";

  const startOver = document.createElement("button");
  startOver.className = "secondary";
  startOver.textContent = "Start over";
  startOver.onclick = resetAll;

  // No close button here (main close button is below)
  btns.appendChild(startOver);
  wrap.appendChild(btns);

  elContent.appendChild(wrap);
}

  function resetAll() {
    state.step = "find";
    state.loading = false;
    state.error = "";
    state.nameQuery = "";
    state.matches = [];
    state.selected = null;
    state.invite = null;

    state.attending = null;
    state.attendingCount = 1;
    state.attendeeNames = [];

    state.transportation = null;
    state.phoneDigits = "";
    state.notes = "";

    render();
  }

  function closeModal() {
    try {
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: "RSVP_CLOSE" }, "*");
      }
    } catch (e) {}
    const modal = document.getElementById("modal");
    if (modal) modal.style.display = "none";
    try { window.close(); } catch (e) {}
  }

  resetAll();
</script>

</body>
</html>
