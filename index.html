<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSVP</title>

  <style>
    :root{
      --bg: rgba(15, 15, 20, 0.55);
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 24px 80px rgba(0,0,0,.18);
      --radius: 18px;

      --btn: #111827;
      --btnText: #ffffff;
      --btnAlt: #f3f4f6;
      --btnAltText: #111827;

      --danger: #b91c1c;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: transparent;
      color: var(--text);
      text-align: center;
    }

    #overlay{
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      box-sizing: border-box;
    }

    #modal{
      width: min(520px, calc(100vw - 36px));
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    header{
      padding: 18px 18px 12px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .title{
      margin:0;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: .2px;
      padding: 0 44px;
    }

    .subtitle{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      padding: 0 44px;
    }

    .xBtn{
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
      color: var(--text);
      user-select: none;
    }
    .xBtn:hover{ background: #f9fafb; }
    .xHidden{ display:none !important; }

    main{ padding: 16px 18px 18px; }

    .col{ display:flex; flex-direction: column; gap: 12px; align-items: center; }

    label{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      display:block;
      text-align: center;
    }

    input, textarea, select{
      width: min(420px, 100%);
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
      color: var(--text);
      text-align: center;
    }

    textarea{ min-height: 96px; resize: vertical; }

    .help{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
      text-align: center;
      max-width: 420px;
    }

    .err{
      color: var(--danger);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
      text-align: center;
      max-width: 420px;
    }

    .hidden{ display:none !important; }

    .btn{
      appearance: none;
      border: 0;
      border-radius: 12px;
      padding: 11px 14px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .btn.primary{
      background: var(--btn);
      color: var(--btnText);
      min-width: 180px;
    }

    .btn.secondary{
      background: var(--btnAlt);
      color: var(--btnAltText);
      border: 1px solid var(--border);
      min-width: 140px;
    }

    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
    }

    /* Unified secondary "choice" buttons (matches, yes/no, transpo, etc.) */
    .choiceBtn{
      width: min(320px, 100%);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      text-align: center;
      display: block;
    }
    .choiceBtn:hover{ background: #f9fafb; }
    .choiceBtn.active{
      background: var(--btn);
      color: var(--btnText);
      border-color: var(--btn);
    }

    .footer{
      display:flex;
      justify-content: center;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
      width: 100%;
    }

    .contactLine{
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      text-align: center;
      max-width: 420px;
    }
  </style>
</head>

<body>
  <div id="overlay" role="dialog" aria-modal="true" aria-label="RSVP">
    <div id="modal">
      <header>
        <h1 class="title" id="headerTitle">RSVP</h1>
        <p class="subtitle" id="headerSubtitle">Find your invite to get started.</p>

        <!-- Sticky X (hidden on end screens) -->
        <button class="xBtn" id="xBtn" type="button" aria-label="Close">×</button>
      </header>

      <main>
        <!-- FIND -->
        <section id="stepFind" class="col">
          <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <label for="nameInput">Full name</label>
            <input id="nameInput" type="text" inputmode="text" autocomplete="name" placeholder="Type your name" />
            <div class="help">Tip: try first and last name.</div>
            <div id="findErr" class="err hidden"></div>
          </div>

          <div class="footer">
            <button class="btn primary" id="findBtn" type="button">Find my invite</button>
          </div>
        </section>

        <!-- PICK -->
        <section id="stepPick" class="col hidden">
          <div id="pickList" class="col" style="width:100%;"></div>
          <div id="pickErr" class="err hidden"></div>

          <div class="footer">
            <button class="btn secondary" id="pickBackBtn" type="button">Back</button>
          </div>
        </section>

        <!-- COMING -->
        <section id="stepComing" class="col hidden">
          <div class="col" style="width:100%;">
            <div class="help" style="margin-top:0;">Will you be attending?</div>

            <button class="choiceBtn" id="btnYes" type="button">Yes</button>
            <button class="choiceBtn" id="btnNo" type="button">No</button>

            <div id="comingErr" class="err hidden"></div>
          </div>

          <!-- Attending details (hidden entirely for single-seat invites) -->
          <div id="attendingBox" class="col hidden" style="width:100%;">
            <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
              <label for="countSelect">How many in your party will attend?</label>
              <select id="countSelect"></select>
              <div class="help">Max: <span id="maxSeatsLabel">4</span></div>
            </div>

            <div id="attendeeInputs" class="col" style="width:100%;"></div>
          </div>

          <div class="footer">
            <button class="btn secondary" id="comingBackBtn" type="button">Back</button>
            <button class="btn primary" id="comingNextBtn" type="button">Next</button>
          </div>
        </section>

        <!-- TRANSPO (Yes/No only) -->
        <section id="stepTranspo" class="col hidden">
          <div class="help" style="margin-top:0;">Will transportation be needed?</div>

          <button class="choiceBtn" id="transpoYes" type="button">Yes</button>
          <button class="choiceBtn" id="transpoNo" type="button">No</button>

          <div id="transpoErr" class="err hidden"></div>

          <div class="footer">
            <button class="btn secondary" id="transpoBackBtn" type="button">Back</button>
            <button class="btn primary" id="transpoNextBtn" type="button">Next</button>
          </div>
        </section>

        <!-- PHONE -->
        <section id="stepPhone" class="col hidden">
          <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <label for="phoneInput">Phone number (Philippines)</label>
            <input id="phoneInput" type="tel" inputmode="numeric" autocomplete="tel" placeholder="09XX XXX XXXX" maxlength="13" />
            <div class="help">Format: 09XX XXX XXXX</div>
            <div id="phoneErr" class="err hidden"></div>
          </div>

          <div class="footer">
            <button class="btn secondary" id="phoneBackBtn" type="button">Back</button>
            <button class="btn primary" id="phoneNextBtn" type="button">Next</button>
          </div>
        </section>

        <!-- NOTES -->
        <section id="stepNotes" class="col hidden">
          <div style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <label for="notesInput">Notes (optional)</label>
            <textarea id="notesInput" placeholder="Dietary restrictions, questions, anything to share"></textarea>
          </div>

          <div class="footer">
            <button class="btn secondary" id="notesBackBtn" type="button">Back</button>
            <button class="btn primary" id="submitBtn" type="button">Submit RSVP</button>
          </div>

          <div id="submitErr" class="err hidden"></div>
        </section>

        <!-- THANKS (end screen: NO X, close button bottom) -->
        <section id="stepThanks" class="col hidden">
          <div style="font-size:16px; font-weight:600;">Thanks, you’re all set.</div>
          <div class="help" id="thanksLine">RSVP received.</div>
          <div class="contactLine" id="contactLine"></div>

          <div class="footer">
            <button class="btn secondary" id="thanksCloseBtn" type="button">Close</button>
          </div>
        </section>

        <!-- DECLINED (end screen: NO X, close button bottom) -->
        <section id="stepDeclined" class="col hidden">
          <div style="font-size:16px; font-weight:600;">Got it. Thank you for letting us know.</div>
          <div class="help">Your response has been recorded.</div>
          <div class="contactLine" id="contactLine2"></div>

          <div class="footer">
            <button class="btn secondary" id="declineCloseBtn" type="button">Close</button>
          </div>
        </section>

        <!-- LOCKED (end screen: NO X, close button bottom) -->
        <section id="stepLocked" class="col hidden">
          <div style="font-size:16px; font-weight:600;">RSVP already received</div>
          <div class="help">
            If you need to update your RSVP, please contact Bianca &amp; Mars (or the coordinator).
          </div>
          <div class="contactLine" id="contactLine3"></div>

          <div class="footer">
            <button class="btn secondary" id="lockedCloseBtn" type="button">Close</button>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script>
    var CONFIG = {
      webAppUrl: "https://script.google.com/macros/s/AKfycbxNMaS4bQoEICGBUa6uH5qL4BOGjhK_f1CajHkSWJkgDe_tTrbAM0KyWHKQd0YKQ4BMxA/exec",
      maxSeatsCap: 4,
      contactLineText:
        "If you already RSVP’d and need to update something, please contact Bianca & Mars (or the coordinator) at +63 XXX XXX XXXX (WhatsApp/Viber)."
    };

    function $(id){ return document.getElementById(id); }
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setText(el, txt){ el.textContent = txt; }
    function showErr(el, msg){ setText(el, msg); show(el); }
    function clearErr(el){ setText(el, ""); hide(el); }

    function normalizeSpaces_(s){ return (s || "").replace(/\s+/g, " ").trim(); }

    // Title Case per word, keeps hyphens + apostrophes
    function titleCaseName_(s){
      s = normalizeSpaces_(s).toLowerCase();
      var out = "";
      var capNext = true;
      for (var i = 0; i < s.length; i++){
        var ch = s[i];
        if (capNext && /[a-z]/.test(ch)) { out += ch.toUpperCase(); capNext = false; }
        else out += ch;
        if (ch === " " || ch === "-" || ch === "'") capNext = true;
      }
      return out;
    }

    function hideAllSteps(){
      hide($("stepFind"));
      hide($("stepPick"));
      hide($("stepComing"));
      hide($("stepTranspo"));
      hide($("stepPhone"));
      hide($("stepNotes"));
      hide($("stepThanks"));
      hide($("stepDeclined"));
      hide($("stepLocked"));
    }

    function setXVisible_(visible){
      if (visible) $("xBtn").classList.remove("xHidden");
      else $("xBtn").classList.add("xHidden");
    }

    // History stack for true "back one screen"
    var navStack = [];

    function go(stepId, title, subtitle, options){
      options = options || {};
      if (!options.noHistory) navStack.push(stepId);

      hideAllSteps();
      show($(stepId));

      if (title) setText($("headerTitle"), title);
      if (subtitle) setText($("headerSubtitle"), subtitle);

      var endScreens = (stepId === "stepThanks" || stepId === "stepDeclined" || stepId === "stepLocked");
      setXVisible_(!endScreens);

      window.scrollTo(0,0);
    }

    function goBackOne(){
      // remove current
      if (navStack.length > 0) navStack.pop();

      // go to previous
      var prev = navStack.length ? navStack[navStack.length - 1] : "stepFind";

      // render without pushing history
      hideAllSteps();
      show($(prev));

      var endScreens = (prev === "stepThanks" || prev === "stepDeclined" || prev === "stepLocked");
      setXVisible_(!endScreens);

      // set header text per screen
      if (prev === "stepFind") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Find your invite to get started."); }
      if (prev === "stepPick") { setText($("headerTitle"), "Select your invite"); setText($("headerSubtitle"), "Choose the name that matches your invite."); }
      if (prev === "stepComing") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Will you be attending?"); }
      if (prev === "stepTranspo") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Transportation"); }
      if (prev === "stepPhone") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Contact number"); }
      if (prev === "stepNotes") { setText($("headerTitle"), "RSVP"); setText($("headerSubtitle"), "Any notes?"); }

      window.scrollTo(0,0);
    }

    // Avoid CORS preflight for Apps Script by using text/plain
    function postJson(action, payload){
      return fetch(CONFIG.webAppUrl, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(Object.assign({ action: action }, payload || {}))
      }).then(function(r){
        return r.text().then(function(t){
          try { return JSON.parse(t); }
          catch(e){ return { ok:false, error:"Bad response from server." }; }
        });
      });
    }

    function closeRSVP(){
      if (window.parent && window.parent !== window) {
        window.parent.postMessage("RSVP:CLOSE", "*");
        return;
      }
      if (window.opener && !window.opener.closed) {
        window.close();
        return;
      }
      window.location.href = "/";
    }

    /* Phone v3 (store visible 09XX XXX XXXX) */
    var phoneDigits = "";

    function digitsOnly(s){ return (s || "").replace(/\D+/g, ""); }

    function formatPHVisible(d){
      var x = (d || "");
      if (x.indexOf("63") === 0 && x.length >= 12) x = "0" + x.slice(2);
      x = x.slice(0, 11);
      var a = x.slice(0, 4);
      var b = x.slice(4, 7);
      var c = x.slice(7, 11);
      var out = a;
      if (b.length) out += " " + b;
      if (c.length) out += " " + c;
      return out.trim();
    }

    function isValidPHVisible(visible){
      return /^09\d{2}\s\d{3}\s\d{4}$/.test((visible || "").trim());
    }

    function setPhoneFromInput(){
      phoneDigits = digitsOnly($("phoneInput").value);
      var visible = formatPHVisible(phoneDigits);
      $("phoneInput").value = visible;
      return visible;
    }

    function validatePhone(showMessage){
      var visible = setPhoneFromInput();
      if (!visible) {
        if (showMessage) showErr($("phoneErr"), "Phone number is required.");
        return { ok:false, kind:"required", visible:visible };
      }
      if (!isValidPHVisible(visible)) {
        if (showMessage) showErr($("phoneErr"), "Phone number is invalid. Please use 09XX XXX XXXX.");
        return { ok:false, kind:"invalid", visible:visible };
      }
      clearErr($("phoneErr"));
      return { ok:true, kind:"ok", visible:visible };
    }

    var state = {
      matches: [],
      selected: null,
      inviteId: null,
      status: null,
      attendingCount: 0,
      attendees: [],
      transportation: "",
      phoneVisible: "",
      notes: ""
    };

    function buildCountSelect(max){
      var sel = $("countSelect");
      sel.innerHTML = "";
      var cap = Math.max(1, Math.min(CONFIG.maxSeatsCap, max || CONFIG.maxSeatsCap));
      setText($("maxSeatsLabel"), String(cap));
      for (var i = 1; i <= cap; i++){
        var opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        sel.appendChild(opt);
      }
      sel.value = "1";
    }

    function buildAttendeeInputs(n){
      var box = $("attendeeInputs");
      box.innerHTML = "";
      for (var i = 0; i < n; i++){
        var wrap = document.createElement("div");
        wrap.style.width = "100%";
        wrap.style.display = "flex";
        wrap.style.flexDirection = "column";
        wrap.style.alignItems = "center";

        var lab = document.createElement("label");
        lab.textContent = (i === 0) ? "Attendee full name" : ("Attendee " + (i+1) + " full name");

        var inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "Type full name";
        inp.dataset.idx = String(i);

        inp.addEventListener("input", function(e){
          var idx = parseInt(e.target.dataset.idx, 10);
          state.attendees[idx] = normalizeSpaces_(e.target.value);
        });

        inp.addEventListener("blur", function(e){
          var idx = parseInt(e.target.dataset.idx, 10);
          var fixed = titleCaseName_(e.target.value);
          e.target.value = fixed;
          state.attendees[idx] = fixed;
        });

        wrap.appendChild(lab);
        wrap.appendChild(inp);
        box.appendChild(wrap);
      }
      state.attendees = new Array(n).fill("");
    }

    function setChoiceActive(btnA, btnB, activeA){
      btnA.classList.toggle("active", !!activeA);
      btnB.classList.toggle("active", !activeA);
    }

    function renderPickList(matches){
      var list = $("pickList");
      list.innerHTML = "";
      matches.forEach(function(m){
        var btn = document.createElement("button");
        btn.type = "button";
        btn.className = "choiceBtn";
        btn.textContent = m.display_name || m.name || "Select";
        btn.addEventListener("click", function(){ selectMatch(m); });
        list.appendChild(btn);
      });
    }

    function resetState(){
      state = { matches:[], selected:null, inviteId:null, status:null, attendingCount:0, attendees:[], transportation:"", phoneVisible:"", notes:"" };
      phoneDigits = "";
      $("nameInput").value = "";
      $("notesInput").value = "";
      $("phoneInput").value = "";

      clearErr($("findErr"));
      clearErr($("pickErr"));
      clearErr($("comingErr"));
      clearErr($("transpoErr"));
      clearErr($("phoneErr"));
      clearErr($("submitErr"));

      setText($("contactLine"), CONFIG.contactLineText);
      setText($("contactLine2"), CONFIG.contactLineText);
      setText($("contactLine3"), CONFIG.contactLineText);

      $("btnYes").classList.remove("active");
      $("btnNo").classList.remove("active");

      $("transpoYes").classList.remove("active");
      $("transpoNo").classList.remove("active");

      hide($("attendingBox"));

      navStack = [];
      go("stepFind", "RSVP", "Find your invite to get started.", { noHistory: false });
    }

    function startFind(){
      clearErr($("findErr"));
      var q = normalizeSpaces_($("nameInput").value);
      if (!q){ showErr($("findErr"), "Please enter your name."); return; }

      $("findBtn").disabled = true;
      postJson("find", { name: q })
        .then(function(res){
          $("findBtn").disabled = false;

          if (!res || res.ok === false){
            showErr($("findErr"), (res && res.error) ? res.error : "Something went wrong. Please try again.");
            return;
          }

          var matches = res.matches || [];
          state.matches = matches;

          if (matches.length === 0){
            showErr($("findErr"), "No match found. Please check spelling or try a different name.");
            return;
          }

          if (matches.length === 1){
            selectMatch(matches[0]);
            return;
          }

          renderPickList(matches);
          clearErr($("pickErr"));
          go("stepPick", "Select your invite", "Choose the name that matches your invite.");
        })
        .catch(function(){
          $("findBtn").disabled = false;
          showErr($("findErr"), "Network error. Please try again.");
        });
    }

    function selectMatch(match){
      var inviteId = match.invite_id || match.id || match.key;
      if (!inviteId){ showErr($("pickErr"), "This invite is missing an ID. Please try again."); return; }

      state.inviteId = inviteId;

      postJson("get", { invite_id: inviteId })
        .then(function(res){
          if (!res || res.ok === false){
            showErr($("pickErr"), (res && res.error) ? res.error : "Unable to load invite. Please try again.");
            return;
          }

          if (res.locked){
            go("stepLocked", "RSVP", "RSVP already received.");
            return;
          }

          state.selected = res.invite || match;

          // Configure seats
          var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;
          buildCountSelect(maxSeats);

          // Reset selection state for coming/transpo
          state.status = null;
          $("btnYes").classList.remove("active");
          $("btnNo").classList.remove("active");
          clearErr($("comingErr"));

          state.transportation = "";
          $("transpoYes").classList.remove("active");
          $("transpoNo").classList.remove("active");
          clearErr($("transpoErr"));

          // Single-seat invites: do not ask for attendee full name
          if (maxSeats <= 1) {
            hide($("attendingBox"));
            state.attendingCount = 1;
            state.attendees = [ titleCaseName_(state.selected.display_name || state.selected.name || "") ];
          } else {
            // Multi-seat: show party size + attendee names
            show($("attendingBox"));
            state.attendingCount = 1;
            buildAttendeeInputs(1);
          }

          go("stepComing", "RSVP", "Will you be attending?");
        })
        .catch(function(){
          showErr($("pickErr"), "Network error. Please try again.");
        });
    }

    function comingNext(){
      clearErr($("comingErr"));

      if (!state.status){
        showErr($("comingErr"), "Please select Yes or No.");
        return;
      }

      if (state.status === "Declined"){
        submitRSVP();
        return;
      }

      var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;

      // Single-seat: auto-fill attendee name already prepared
      if (maxSeats <= 1) {
        state.attendingCount = 1;
        state.attendees = [ titleCaseName_(state.selected.display_name || state.selected.name || "") ];
      } else {
        state.attendingCount = parseInt($("countSelect").value, 10) || 1;

        var missing = [];
        for (var i = 0; i < state.attendingCount; i++){
          var v = titleCaseName_(state.attendees[i]);
          state.attendees[i] = v;
          if (!v) missing.push(i+1);
        }
        if (missing.length){
          showErr($("comingErr"), "Please enter attendee name" + (missing.length > 1 ? "s" : "") + ".");
          return;
        }
      }

      go("stepTranspo", "RSVP", "Transportation");
    }

    function transpoNext(){
      clearErr($("transpoErr"));
      if (!state.transportation){
        showErr($("transpoErr"), "Please select Yes or No.");
        return;
      }
      go("stepPhone", "RSVP", "Contact number");
    }

    function phoneNext(){
      var v = validatePhone(true);
      if (!v.ok) return;
      state.phoneVisible = v.visible;
      go("stepNotes", "RSVP", "Any notes?");
    }

    function submitRSVP(){
      clearErr($("submitErr"));

      if (state.status === "Attending"){
        // Ensure attendee names are title-cased before sending
        state.attendees = (state.attendees || []).map(function(nm){ return titleCaseName_(nm); });

        var v = validatePhone(true);
        if (!v.ok){
          showErr($("submitErr"), v.kind === "required"
            ? "Phone number is required. Please go back and enter 09XX XXX XXXX."
            : "Phone number is invalid. Please go back and use 09XX XXX XXXX."
          );
          return;
        }
        state.phoneVisible = v.visible;
      } else {
        state.phoneVisible = "";
      }

      state.notes = normalizeSpaces_($("notesInput").value);

      var payload = {
        invite_id: state.inviteId,
        status: state.status,
        attending_count: state.status === "Attending" ? state.attendingCount : 0,
        phone: state.phoneVisible || "",
        transportation: state.status === "Attending" ? (state.transportation || "") : "",
        notes: state.notes || "",
        attendees: state.status === "Attending" ? state.attendees.slice(0, state.attendingCount) : []
      };

      $("submitBtn").disabled = true;
      $("comingNextBtn").disabled = true;

      postJson("submit", payload)
        .then(function(res){
          $("submitBtn").disabled = false;
          $("comingNextBtn").disabled = false;

          if (!res || res.ok === false){
            showErr($("submitErr"), (res && res.error) ? res.error : "Unable to submit. Please try again.");
            return;
          }

          if (res.locked){
            go("stepLocked", "RSVP", "RSVP already received.");
            return;
          }

          if (state.status === "Declined"){
            go("stepDeclined", "RSVP", "Response recorded.");
            return;
          }

          setText($("thanksLine"), "RSVP received for " + state.attendingCount + (state.attendingCount === 1 ? " guest." : " guests."));
          go("stepThanks", "RSVP", "Response recorded.");
        })
        .catch(function(){
          $("submitBtn").disabled = false;
          $("comingNextBtn").disabled = false;
          showErr($("submitErr"), "Network error. Please try again.");
        });
    }

    // Bind events
    $("xBtn").addEventListener("click", closeRSVP);
    $("thanksCloseBtn").addEventListener("click", closeRSVP);
    $("declineCloseBtn").addEventListener("click", closeRSVP);
    $("lockedCloseBtn").addEventListener("click", closeRSVP);

    $("findBtn").addEventListener("click", startFind);
    $("nameInput").addEventListener("keydown", function(e){ if (e.key === "Enter") startFind(); });

    $("pickBackBtn").addEventListener("click", goBackOne);
    $("comingBackBtn").addEventListener("click", goBackOne);
    $("transpoBackBtn").addEventListener("click", goBackOne);
    $("phoneBackBtn").addEventListener("click", goBackOne);
    $("notesBackBtn").addEventListener("click", goBackOne);

    $("btnYes").addEventListener("click", function(){
      state.status = "Attending";
      $("btnYes").classList.add("active");
      $("btnNo").classList.remove("active");
      clearErr($("comingErr"));

      var maxSeats = (state.selected && state.selected.max_seats) ? state.selected.max_seats : CONFIG.maxSeatsCap;

      if (maxSeats <= 1) {
        hide($("attendingBox"));
        state.attendingCount = 1;
        state.attendees = [ titleCaseName_(state.selected.display_name || state.selected.name || "") ];
      } else {
        show($("attendingBox"));
        state.attendingCount = parseInt($("countSelect").value, 10) || 1;
        buildAttendeeInputs(state.attendingCount);
      }
    });

    $("btnNo").addEventListener("click", function(){
      state.status = "Declined";
      $("btnNo").classList.add("active");
      $("btnYes").classList.remove("active");
      hide($("attendingBox"));
      clearErr($("comingErr"));
    });

    $("countSelect").addEventListener("change", function(){
      var n = parseInt($("countSelect").value, 10) || 1;
      state.attendingCount = n;
      buildAttendeeInputs(n);
    });

    $("comingNextBtn").addEventListener("click", comingNext);

    $("transpoYes").addEventListener("click", function(){
      state.transportation = "Yes";
      $("transpoYes").classList.add("active");
      $("transpoNo").classList.remove("active");
      clearErr($("transpoErr"));
    });
    $("transpoNo").addEventListener("click", function(){
      state.transportation = "No";
      $("transpoNo").classList.add("active");
      $("transpoYes").classList.remove("active");
      clearErr($("transpoErr"));
    });

    $("transpoNextBtn").addEventListener("click", transpoNext);

    $("phoneInput").addEventListener("input", function(){
      setPhoneFromInput();
      hide($("phoneErr"));
    });
    $("phoneInput").addEventListener("blur", function(){ validatePhone(false); });
    $("phoneNextBtn").addEventListener("click", phoneNext);

    $("submitBtn").addEventListener("click", submitRSVP);

    resetState();
  </script>
</body>
</html>
