<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSVP</title>
  <style>
    :root{
      --bg:transparent;
      --card:#f6f7fb;
      --text:#141418;
      --muted:#5a5a66;
      --line:#dcdde6;
      --err:#c62828;

      --btn:#141418;
      --btnText:#ffffff;

      --pillBg:#eef1ff;
      --pillBorder:#cfd6ff;
      --pillHover:#e3e8ff;
      --pillActive:#d7dfff;
      --pillActiveBorder:#b9c6ff;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:transparent;
      color:var(--text);
    }

    #overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.60);
      z-index: 9998;
    }

    #modal{
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);

      z-index: 9999;
      width:min(420px, calc(100vw - 32px));
      max-height: calc(100vh - 32px);
      overflow: auto;

      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      text-align:center;
    }

    #header{
      padding:18px 18px 10px;
      border-bottom:1px solid var(--line);
      text-align:center;
    }

    #title{
      margin:0;
      font-size:20px;
      font-weight:700;
      letter-spacing:.2px;
    }

    #subtitle{
      margin:8px 0 0;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }

    #content{
      padding:16px 18px 18px;
      text-align:center;
    }

    .row{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      text-align:center;
    }

    input, select, textarea{
      width:100%;
      max-width:360px;
      box-sizing:border-box;
      border-radius:12px;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
      text-align:center;
    }

    textarea{
      min-height:92px;
      resize:vertical;
      text-align:center;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      text-align:center;
      max-width:360px;
    }

    .error{
      width:100%;
      max-width:360px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(198,40,40,.35);
      background: rgba(198,40,40,.08);
      color:var(--err);
      font-size:13px;
      text-align:center;
    }

    .btns{
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:16px;
      flex-wrap:wrap;
    }

    button{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:650;
      cursor:pointer;
      font-size:14px;
    }

    button.primary{
      background: var(--btn);
      color: var(--btnText);
      border: none;
      min-width: 140px;
    }

    button.primary:hover{ background:#2a2a30; }

    button.secondary{
      background:#ffffff;
      border: 1.5px solid var(--line);
      color: var(--text);
      min-width: 140px;
    }

    button.secondary:hover{
      background:#f0f1f6;
      border-color:#c9cada;
    }

    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .pillRow{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:4px;
    }

    .pill{
      background: var(--pillBg);
      border: 1.5px solid var(--pillBorder);
      color: var(--text);
      min-width:150px;
      border-radius:999px;
      padding:11px 16px;
      font-weight:700;
      transition: background .08s ease, border-color .08s ease;
    }

    .pill:hover{
      background: var(--pillHover);
      border-color: var(--pillActiveBorder);
    }

    .pill.active{
      background: var(--pillActive);
      border-color: var(--pillActiveBorder);
    }

    .pickList{
      display:flex;
      flex-direction:column;
      gap:10px;
      width:100%;
      align-items:stretch;
    }

    button.pickBtn{
      width:100%;
      max-width:360px;
      margin:0 auto;
      padding:14px 16px;

      background:#ffffff;
      border: 1.5px solid var(--line);
      border-radius:14px;

      font-size:15px;
      font-weight:650;
      color:var(--text);
      text-align:center;
    }

    button.pickBtn:hover{
      background:#f0f1f6;
      border-color:#c9cada;
    }

    .loading{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color:var(--muted);
      font-size:13px;
      margin-top:4px;
    }

    .dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:var(--muted);
      animation:b 1s infinite ease-in-out;
    }

    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}

    @keyframes b{
      0%,80%,100%{transform:scale(.7); opacity:.6}
      40%{transform:scale(1.1); opacity:1}
    }

    @media (max-width: 420px){
      button.primary,
      button.secondary{
        width: 100%;
        max-width: 360px;
      }

      .btns{
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>

<body>
  <div id="overlay" aria-hidden="true"></div>

  <div id="modal" role="dialog" aria-modal="true">
    <div id="header">
      <h1 id="title">RSVP</h1>
      <p id="subtitle"></p>
    </div>

    <div id="content"></div>
  </div>

<script>
  const CONFIG = {
    webAppUrl: "https://script.google.com/macros/s/AKfycbxNMaS4bQoEICGBUa6uH5qL4BOGjhK_f1CajHkSWJkgDe_tTrbAM0KyWHKQd0YKQ4BMxA/exec",
    maxSeatsCap: 4
  };

  const state = {
    step: "find",
    loading: false,
    error: "",
    contactLine: "",
    nameQuery: "",
    matches: [],
    invite: null,

    attending: null,
    attendingCount: 1,
    attendeeNames: [],

    transportation: null,
    phoneDigits: "",
    notes: ""
  };

  const elTitle = document.getElementById("title");
  const elSubtitle = document.getElementById("subtitle");
  const elContent = document.getElementById("content");

  function setHeader(title, subtitle) {
    elTitle.textContent = title;
    elSubtitle.textContent = subtitle || "";
  }

  function errorEl(msg) {
    const err = document.createElement("div");
    err.className = "error";
    err.textContent = msg;
    return err;
  }

  function pill(text, active, onClick) {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "pill" + (active ? " active" : "");
    b.textContent = text;
    b.addEventListener("click", onClick);
    return b;
  }

  function clamp(n, a, b) {
    const x = Number(n);
    if (!Number.isFinite(x)) return a;
    return Math.min(Math.max(x, a), b);
  }

  function loadingRow() {
    const div = document.createElement("div");
    div.className = "loading";
    div.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span><span>Loading…</span>`;
    return div;
  }

  async function api(action, payload) {
    const res = await fetch(CONFIG.webAppUrl, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action, ...(payload || {}) })
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch (e) { return { ok: false, error: "Invalid server response.", raw: text }; }
  }

  function syncAttendeeNames_(maxSeats) {
    const cnt = clamp(Number(state.attendingCount || 1), 1, maxSeats);
    state.attendingCount = cnt;

    const arr = Array.isArray(state.attendeeNames) ? state.attendeeNames.slice(0, cnt) : [];
    while (arr.length < cnt) arr.push("");
    state.attendeeNames = arr;
  }

  function digits11_(s) {
    return String(s || "").replace(/[^\d]/g, "").slice(0, 11);
  }

  function formatPH09_(digits) {
    const d = digits11_(digits);
    const p1 = d.slice(0, 4);
    const p2 = d.slice(4, 7);
    const p3 = d.slice(7, 11);
    if (d.length <= 4) return p1;
    if (d.length <= 7) return `${p1} ${p2}`;
    return `${p1} ${p2} ${p3}`;
  }

  function phoneStatus_(digits) {
    const d = digits11_(digits);
    if (!d) return { ok: false, reason: "empty", visible: "" };
    if (d.length !== 11 || !d.startsWith("09")) return { ok: false, reason: "invalid", visible: formatPH09_(d) };
    return { ok: true, reason: "ok", visible: formatPH09_(d) };
  }

  function render() {
    elContent.innerHTML = "";

    if (state.step === "find") return renderFind();
    if (state.step === "pick") return renderPick();
    if (state.step === "coming") return renderComing();
    if (state.step === "transpo") return renderTranspo();
    if (state.step === "phone") return renderPhone();
    if (state.step === "notes") return renderNotes();
    if (state.step === "locked") return renderLocked();
    if (state.step === "thanks") return renderThanks();
    if (state.step === "declined") return renderDeclined();

    state.step = "find";
    renderFind();
  }

  function renderFind() {
    setHeader("Find your invite", "Type the name on the invitation.");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Full name";
    input.value = state.nameQuery;
    input.addEventListener("input", (e) => state.nameQuery = e.target.value);
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") onFind(); });
    wrap.appendChild(input);

    if (state.loading) wrap.appendChild(loadingRow());
    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const btn = document.createElement("button");
    btn.className = "primary";
    btn.type = "button";
    btn.textContent = "Find invite";
    btn.disabled = state.loading;
    btn.onclick = onFind;

    btns.appendChild(btn);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
    setTimeout(() => input.focus(), 0);
  }

  async function onFind() {
    state.error = "";
    const name = (state.nameQuery || "").trim();
    if (!name) { state.error = "Please type a name first."; return render(); }

    state.loading = true;
    render();

    try {
      const data = await api("find", { name });
      state.loading = false;

      if (!data || !data.ok) throw new Error(data?.error || "Search failed.");
      state.contactLine = data.contact_line || "";
      state.matches = Array.isArray(data.matches) ? data.matches : [];

      if (state.matches.length === 0) {
        state.error = "No match found. Try a different spelling.";
        return render();
      }

      state.step = "pick";
      render();
    } catch (err) {
      state.loading = false;
      state.error = String(err?.message || err);
      render();
    }
  }

  function renderPick() {
    setHeader("Verify your name", "Tap your name to continue.");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const list = document.createElement("div");
    list.className = "pickList";

    state.matches.forEach((m) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "pickBtn";
      btn.textContent = m.invite_name || "Unnamed guest";
      btn.onclick = () => onPick(m);
      list.appendChild(btn);
    });

    wrap.appendChild(list);

    if (state.loading) wrap.appendChild(loadingRow());
    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.type = "button";
    back.textContent = "Back";
    back.disabled = state.loading;
    back.onclick = () => { state.error = ""; state.step = "find"; render(); };

    btns.appendChild(back);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  async function onPick(m) {
    state.error = "";
    state.loading = true;
    render();

    try {
      const data = await api("get", { invite_id: m.invite_id });
      state.loading = false;

      if (!data || !data.ok) throw new Error(data?.error || "Could not load invite.");

      state.contactLine = data.contact_line || state.contactLine || "";
      state.invite = data.invite || null;

      if (!state.invite) throw new Error("Missing invite data.");

      if (state.invite.locked) {
        state.step = "locked";
        return render();
      }

      state.attending = null;
      state.attendingCount = 1;
      state.attendeeNames = [];
      state.transportation = null;
      state.phoneDigits = "";
      state.notes = "";

      state.step = "coming";
      render();
    } catch (err) {
      state.loading = false;
      state.error = String(err?.message || err);
      render();
    }
  }

  function renderComing() {
    const inviteName = state.invite?.invite_name || "Guest";
    const maxSeats = Math.min(Number(state.invite?.max_seats || 1), CONFIG.maxSeatsCap);

    setHeader("RSVP", `${inviteName}, are you coming?`);

    const wrap = document.createElement("div");
    wrap.className = "row";

    const pills = document.createElement("div");
    pills.className = "pillRow";

    pills.appendChild(pill("Yes", state.attending === "yes", () => {
      state.attending = "yes";

      if (maxSeats === 1) {
        state.attendingCount = 1;
        state.attendeeNames = [inviteName];
      } else {
        state.attendingCount = clamp(state.attendingCount || 1, 1, maxSeats);
        syncAttendeeNames_(maxSeats);
      }

      state.error = "";
      render();
    }));

    pills.appendChild(pill("No", state.attending === "no", () => {
      state.attending = "no";
      state.attendingCount = 0;
      state.attendeeNames = [];
      state.error = "";
      render();
    }));

    wrap.appendChild(pills);

    if (state.attending === "yes" && maxSeats > 1) {
      const select = document.createElement("select");
      for (let i = 1; i <= maxSeats; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${i}`;
        if (i === Number(state.attendingCount || 1)) opt.selected = true;
        select.appendChild(opt);
      }
      select.onchange = (e) => {
        state.attendingCount = Number(e.target.value);
        syncAttendeeNames_(maxSeats);
        render();
      };
      wrap.appendChild(select);

      syncAttendeeNames_(maxSeats);

      const note = document.createElement("div");
      note.className = "muted";
      note.textContent = "Please enter the full name of each attendee.";
      wrap.appendChild(note);

      for (let i = 0; i < state.attendingCount; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = `Attendee ${i + 1} full name`;
        input.value = state.attendeeNames[i] || "";
        input.oninput = (e) => { state.attendeeNames[i] = e.target.value; };
        wrap.appendChild(input);
      }
    }

    if (state.loading) wrap.appendChild(loadingRow());
    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.onclick = () => { state.error = ""; state.step = "pick"; render(); };

    const next = document.createElement("button");
    next.className = "primary";
    next.textContent = "Next";

    next.onclick = async () => {
      state.error = "";

      if (state.attending !== "yes" && state.attending !== "no") {
        state.error = "Please choose Yes or No.";
        return render();
      }

      if (state.attending === "no") {
        state.loading = true;
        render();
        try {
          const payload = {
            invite_id: state.invite.invite_id,
            attending: "no",
            attending_count: 0,
            attendees: [],
            phone: "",
            transportation: "",
            notes: ""
          };
          const data = await api("submit", payload);
          state.loading = false;

          if (!data || !data.ok) {
            if (data && data.locked) {
              state.contactLine = data.contact_line || state.contactLine || "";
              state.step = "locked";
              return render();
            }
            throw new Error(data?.error || "Submit failed.");
          }

          state.step = "declined";
          return render();
        } catch (err) {
          state.loading = false;
          state.error = String(err?.message || err);
          return render();
        }
      }

      if (maxSeats === 1) {
        state.attendingCount = 1;
        state.attendeeNames = [inviteName];
        state.step = "transpo";
        return render();
      }

      const cleaned = (state.attendeeNames || [])
        .slice(0, state.attendingCount)
        .map(n => (n || "").trim());

      if (cleaned.length !== state.attendingCount || cleaned.some(n => !n)) {
        state.error = "Please fill in all attendee names.";
        return render();
      }

      state.step = "transpo";
      render();
    };

    btns.appendChild(back);
    btns.appendChild(next);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  function renderTranspo() {
    setHeader("Transportation", "Do you need transport arrangements from NAIA to the venue?");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const pills = document.createElement("div");
    pills.className = "pillRow";

    pills.appendChild(pill("Yes", state.transportation === "Yes", () => { state.transportation = "Yes"; state.error=""; render(); }));
    pills.appendChild(pill("No", state.transportation === "No", () => { state.transportation = "No"; state.error=""; render(); }));

    wrap.appendChild(pills);

    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.onclick = () => { state.error=""; state.step = "coming"; render(); };

    const next = document.createElement("button");
    next.className = "primary";
    next.textContent = "Next";
    next.onclick = () => {
      state.error = "";
      if (state.transportation !== "Yes" && state.transportation !== "No") {
        state.error = "Please choose Yes or No.";
        return render();
      }
      state.step = "phone";
      render();
    };

    btns.appendChild(back);
    btns.appendChild(next);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  function renderPhone() {
    setHeader("Mobile number", "Please enter your PH mobile number.");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const input = document.createElement("input");
    input.type = "tel";
    input.inputMode = "numeric";
    input.autocomplete = "tel";
    input.placeholder = "09XX XXX XXXX";
    input.maxLength = 13;
    input.value = formatPH09_(state.phoneDigits);

    const helper = document.createElement("div");
    helper.className = "muted";
    helper.textContent = "Format: 09XX XXX XXXX";
    wrap.appendChild(helper);

    input.oninput = (e) => {
      const digits = digits11_(e.target.value);
      state.phoneDigits = digits;
      e.target.value = formatPH09_(digits);
      state.error = "";
      render();
    };

    wrap.appendChild(input);

    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.onclick = () => { state.error=""; state.step = "transpo"; render(); };

    const next = document.createElement("button");
    next.className = "primary";
    next.textContent = "Next";
    next.onclick = () => {
      state.error = "";

      const s = phoneStatus_(state.phoneDigits);
      if (!s.ok) {
        state.error = (s.reason === "empty")
          ? "Phone number is required."
          : "Phone number invalid. Please use 11 digits starting with 09.";
        return render();
      }

      state.step = "notes";
      render();
    };

    btns.appendChild(back);
    btns.appendChild(next);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
    setTimeout(() => input.focus(), 0);
  }

  function renderNotes() {
    setHeader("Notes", "Anything else? (Optional)");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const ta = document.createElement("textarea");
    ta.placeholder = "Type your notes here (optional)";
    ta.value = state.notes || "";
    ta.oninput = (e) => state.notes = e.target.value;
    wrap.appendChild(ta);

    if (state.loading) wrap.appendChild(loadingRow());
    if (state.error) wrap.appendChild(errorEl(state.error));

    const btns = document.createElement("div");
    btns.className = "btns";

    const back = document.createElement("button");
    back.className = "secondary";
    back.textContent = "Back";
    back.disabled = state.loading;
    back.onclick = () => { state.error=""; state.step = "phone"; render(); };

    const submit = document.createElement("button");
    submit.className = "primary";
    submit.textContent = state.loading ? "Submitting…" : "Submit RSVP";
    submit.disabled = state.loading;
    submit.onclick = onSubmit;

    btns.appendChild(back);
    btns.appendChild(submit);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  async function onSubmit() {
    state.error = "";

    if (!state.invite?.invite_id) {
      state.error = "Missing invite details. Please start again.";
      state.step = "find";
      return render();
    }

    if (state.attending !== "yes" && state.attending !== "no") {
      state.error = "Please choose Yes or No.";
      state.step = "coming";
      return render();
    }

    if (state.transportation !== "Yes" && state.transportation !== "No") {
      state.error = "Please choose Yes or No for transportation.";
      state.step = "transpo";
      return render();
    }

    const phoneCheck = phoneStatus_(state.phoneDigits);
    if (!phoneCheck.ok) {
      state.error = phoneCheck.reason === "empty"
        ? "Phone number is required."
        : "Phone number invalid. Please use 11 digits starting with 09.";
      state.step = "phone";
      return render();
    }

    let attendees = [];
    let attending_count = 0;

    if (state.attending === "yes") {
      const maxSeats = Math.min(Number(state.invite.max_seats || 1), CONFIG.maxSeatsCap);

      if (maxSeats === 1) {
        attendees = [String(state.invite.invite_name || "").trim() || "Guest"];
        attending_count = 1;
      } else {
        const cnt = clamp(Number(state.attendingCount || 1), 1, maxSeats);

        attendees = (state.attendeeNames || []).slice(0, cnt).map(s => (s || "").trim());
        if (attendees.length !== cnt || attendees.some(x => !x)) {
          state.error = "Please fill in all attendee names.";
          state.step = "coming";
          return render();
        }
        attending_count = cnt;
      }
    }

    const payload = {
      invite_id: state.invite.invite_id,
      attending: state.attending,
      attending_count,
      attendees: state.attending === "yes" ? attendees : [],
      phone: phoneCheck.visible,
      transportation: state.transportation,
      notes: (state.notes || "").trim()
    };

    state.loading = true;
    render();

    try {
      const data = await api("submit", payload);
      state.loading = false;

      if (!data || !data.ok) {
        if (data && data.locked) {
          state.contactLine = data.contact_line || state.contactLine || "";
          state.step = "locked";
          return render();
        }

        const msg = String(data?.error || "Submit failed.");
        if (msg.toLowerCase().includes("phone")) {
          state.error = msg;
          state.step = "phone";
          return render();
        }

        throw new Error(msg);
      }

      state.step = "thanks";
      render();
    } catch (err) {
      state.loading = false;
      state.error = String(err?.message || err);
      render();
    }
  }

  function renderLocked() {
    setHeader("RSVP already received", "For changes, please contact the coordinator.");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const msg = document.createElement("div");
    msg.className = "muted";
    msg.textContent = state.contactLine || "Please contact the coordinator for changes.";
    wrap.appendChild(msg);

    const btns = document.createElement("div");
    btns.className = "btns";

    const startOver = document.createElement("button");
    startOver.className = "secondary";
    startOver.textContent = "Start over";
    startOver.onclick = resetAll;

    btns.appendChild(startOver);
    wrap.appendChild(btns);

    elContent.appendChild(wrap);
  }

  function renderThanks() {
    setHeader("Thank you!", "RSVP received.");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const msg = document.createElement("div");
    msg.className = "muted";
    msg.textContent = "You may close this window.";
    wrap.appendChild(msg);

    elContent.appendChild(wrap);
  }

  function renderDeclined() {
    setHeader("Thank you!", "We’re so sorry you won’t be able to make it!");

    const wrap = document.createElement("div");
    wrap.className = "row";

    const msg = document.createElement("div");
    msg.className = "muted";
    msg.textContent = "You may close this window.";
    wrap.appendChild(msg);

    elContent.appendChild(wrap);
  }

  function resetAll() {
    state.step = "find";
    state.loading = false;
    state.error = "";
    state.nameQuery = "";
    state.matches = [];
    state.invite = null;

    state.attending = null;
    state.attendingCount = 1;
    state.attendeeNames = [];

    state.transportation = null;
    state.phoneDigits = "";
    state.notes = "";

    render();
  }

  // Always visible
  resetAll();
</script>
</body>
</html>
